function getServiceHourMetaform(){return {"title":"Palveluaika","sections":[{"title":"Palvelunajan tyyppi","fields":[{"title":"Valitse","name":"type","type":"radio","required":true,"options":[{"name":"Standard","text":"Normaalit palveluajat: viikonpäivät","checked":true},{"name":"Special","text":"Normaalit palveluajat: vuorokauden yli (päivystys)"},{"name":"Exception","text":"Poikkeavat palveluajat"}],"contexts":["FORM"],"editable":true}]},{"visible-if":{"field":"type","equals":"Standard"},"title":"Normaalit palveluajat: viikonpäivät","fields":[{"title":"Toistaiseksi voimassa oleva","name":"Standard-validForNow","type":"radio","required":true,"options":[{"name":"true","text":"Toistaiseksi voimassa oleva","checked":true},{"name":"false","text":"Voimassa ajanjaksolla"}],"contexts":["FORM"],"editable":true},{"visible-if":{"field":"Standard-validForNow","equals":"false"},"title":"Voimassaolo alkaa","name":"Standard-validFrom","type":"date","required":true,"contexts":["FORM"],"editable":true},{"visible-if":{"field":"Standard-validForNow","equals":"false"},"title":"Voimassaolo päättyy","name":"Standard-validTo","type":"date","required":true,"contexts":["FORM"],"editable":true},{"title":"Aina avoinna (24/7).","name":"Standard-open24h","type":"boolean","required":true,"contexts":["FORM"],"editable":true},{"visible-if":{"field":"Standard-open24h","not-equals":true},"name":"Standard-openinghours","type":"table","title":"Palveluajat","required":true,"contexts":"FORM","addRows":true,"columns":[{"type":"enum","title":"Viikonpäivä","name":"day","values":[{"value":"1","text":"Maanantai"},{"value":"2","text":"Tiistai"},{"value":"3","text":"Keskiviikko"},{"value":"4","text":"Torstai"},{"value":"5","text":"Perjantai"},{"value":"6","text":"Lauantai"},{"value":"0","text":"Sunnuntai"}]},{"type":"time","title":"Avautuu","name":"from"},{"type":"time","title":"Sulkeutuu","name":"to"}]}]},{"visible-if":{"field":"type","equals":"Special"},"title":"Normaalit palveluajat: vuorokauden yli (päivystys)","fields":[{"title":"Toistaiseksi voimassa oleva","name":"Special-validForNow","type":"radio","required":true,"options":[{"name":"true","text":"Toistaiseksi voimassa oleva","checked":true},{"name":"false","text":"Voimassa ajanjaksolla"}],"contexts":["FORM"],"editable":true}]},{"visible-if":{"field":"type","equals":"Special"},"fields":[{"visible-if":{"field":"Special-validForNow","not-equals":"true"},"title":"Voimassaolo alkaa","name":"Special-validFrom","type":"date-time","required":true,"contexts":["FORM"],"editable":true},{"visible-if":{"field":"Special-validForNow","not-equals":"true"},"title":"Voimassaolo päättyy","name":"Special-validTo","type":"date-time","required":true,"contexts":["FORM"],"editable":true},{"title":"Alkupäivä","name":"Special-from-date","type":"select","options":[{"name":"1","text":"Maanantai"},{"name":"2","text":"Tiistai"},{"name":"3","text":"Keskiviikko"},{"name":"4","text":"Torstai"},{"name":"5","text":"Perjantai"},{"name":"6","text":"Lauantai"},{"name":"0","text":"Sunnuntai"}]},{"title":"Alkuaika","name":"Special-from-time","type":"time","required":true,"contexts":["FORM"],"editable":true},{"title":"Päättysmispäivä","name":"Special-to-date","type":"select","options":[{"name":"1","text":"Maanantai"},{"name":"2","text":"Tiistai"},{"name":"3","text":"Keskiviikko"},{"name":"4","text":"Torstai"},{"name":"5","text":"Perjantai"},{"name":"6","text":"Lauantai"},{"name":"0","text":"Sunnuntai"}]},{"title":"Päättymisaika","name":"Special-to-time","type":"time","required":true,"contexts":["FORM"],"editable":true}]},{"visible-if":{"field":"type","equals":"Exception"},"title":"Poikkeavat palveluajat","fields":[{"title":"Lisätieto ({LOCALE})","name":"Exception-additional-information-{LOCALE}","type":"text","required":true,"contexts":["FORM"],"editable":true},{"name":"Exception-type","type":"radio","required":true,"options":[{"name":"single","text":"Päivä"},{"name":"range","text":"Ajanjakso"},{"name":"closed-all-day","text":"Suljettu koko päivän","checked":true}],"contexts":["FORM"],"editable":true},{"title":"Alkupäivä","name":"Exception-from-date","type":"date","required":true,"contexts":["FORM"],"editable":true},{"visible-if":{"field":"Exception-type","equals":"range"},"title":"Päättymispäivä","name":"Exception-to-date","type":"date","required":true,"contexts":["FORM"],"editable":true},{"visible-if":{"field":"Exception-type","equals":"single","or":[{"field":"Exception-type","equals":"range"}]},"title":"Alkamisaika","name":"Exception-from-time","type":"time","required":true,"contexts":["FORM"],"editable":true},{"visible-if":{"field":"Exception-type","equals":"single","or":[{"field":"Exception-type","equals":"range"}]},"title":"Päättymisaika","name":"Exception-to-time","type":"time","required":true,"contexts":["FORM"],"editable":true}]}]};}function getServiceLocationServiceChannelMetaform(){return {"title":"Palvelupiste","sections":[{"fields":[{"name":"name","type":"text","title":"Nimi","required":false,"contexts":"FORM","placeholder":"Kirjoita palvelupaikan nimi."},{"name":"shortDescription","type":"memo","title":"Tiivistelmä","required":false,"contexts":"FORM","placeholder":"Kirjoita lyhyt tiivistelmä hakukoneita varten."},{"name":"description","type":"memo","title":"Kuvaus","required":false,"contexts":"FORM","placeholder":"Kirjoita selkeä ja ymmärrettävä kuvausteksti."}]},{"fields":[{"name":"addresses","type":"table","title":"Käyntiosoite","required":false,"contexts":"FORM","addRows":true,"columns":[{"type":"text","name":"street","title":"Kadunnimi","placeholder":"esim. Mannerheimintie","column-width":300},{"type":"text","name":"streetNumber","title":"Osoitenumero","placeholder":"esim. 12 A 23","column-width":40},{"type":"text","name":"postOfficeCode","title":"Postinumero","column-width":270,"placeholder":"Postitoimipaikka haetaan automaaattisesti"},{"type":"text","name":"additionalInformation","title":"Osoitteen lisätieto","placeholder":"Anna tarvittaessa osoitetta täsmentävä tieto tekstinä."}]},{"name":"foreignAddresses","type":"table","title":"Käyntiosoite - ulkomainen (Vapaasti täydennettävä osoite)","required":false,"contexts":"FORM","addRows":true,"columns":[{"type":"text","name":"foreign","placeholder":"Kirjoita ulkomainen osoite."}]},{"name":"emails","type":"table","title":"Sähköpostit","required":false,"contexts":"FORM","addRows":true,"columns":[{"type":"text","name":"email","placeholder":"esim. osoite@organisaatio.fi"}]},{"name":"serviceHours","type":"html","title":"Palveluajat","required":false,"contexts":"FORM","html":"<table class=\"serviceHours\"><tbody></tbody></table>"},{"name":"add-service-hour","type":"html","html":"<a class=\"btn btn-sm btn-success add-service-hour\">Lisää palveluaika</a>"}]}]};}'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}/* global ajaxurl, tinymce, moment */(function(tinymce,$){var SUPPORTED_COMPONENTS={'name':{'title':'Palvelupisteen nimi'},'description':{'title':'Palvelupisteen kuvaus'},'email':{'title':'Palvelupisteen s\xE4hk\xF6postiosoitteet'},'addresses':{'title':'Palvelupisteen osoitetiedot'},'fax':{'title':'Palvelupisteen faksi'},'phone':{'title':'Palvelupisteen puhelinnumerot'},'servicehours':{'title':'Palvelupisteen aukioloajat'},'webpages':{'title':'Palvelupisteen verkkosivustot'}};var ServiceLocationServiceChannelDialog=function(){function ServiceLocationServiceChannelDialog(editor,serviceLocationServiceChannel){_classCallCheck(this,ServiceLocationServiceChannelDialog);this.serviceLocationServiceChannel=serviceLocationServiceChannel;this.supportedLocales=['fi','en','sv'];this.localeNames={'fi':'Suomi','en':'Englanti','sv':'Ruotsi'};this.serviceHourTypeNames={'Special':'P\xE4ivystys','Standard':'Normaali','Exception':'Poikkeus'};this.dayNames={0:'Sunnuntai',1:'Maanantai',2:'Tiistai',3:'Keskiviikko',4:'Torstai',5:'Perjantai',6:'Lauantai'};this.editor=editor;this.listeners=[];// TODO: Kielet, joilla palvelupisteessä palvellaan
// TODO: Phone Numbers
// TODO: Web Pages
}_createClass(ServiceLocationServiceChannelDialog,[{key:'getLocaleName',value:function getLocaleName(locale){return this.localeNames[locale]}},{key:'getServiceHourTypeName',value:function getServiceHourTypeName(type){return this.serviceHourTypeNames[type]}},{key:'getDayName',value:function getDayName(index,short){var name=this.dayNames[index];if(short){return name.substring(0,2)}return name}},{key:'formatServiceHour',value:function formatServiceHour(serviceHour){var _this=this;var type=this.getServiceHourTypeName(serviceHour.serviceHourType);if(serviceHour.serviceHourType==='Exception'){var result='('+type+')';if(serviceHour.isClosed){result+=' Suljettu'}var openingHour=serviceHour.openingHour&&serviceHour.openingHour.length?serviceHour.openingHour[0]:null;var openFrom=openingHour?openingHour.from:null;var openTo=openingHour?openingHour.to:null;if(serviceHour.validFrom&&serviceHour.validTo){result+=' '+this.formatDateWithTime(serviceHour.validFrom,openFrom)+' - '+this.formatDateWithTime(serviceHour.validTo,openTo)}else if(serviceHour.validFrom){result+=' '+this.formatDateWithTimes(serviceHour.validFrom,openFrom,openTo)}var additionalInformation=this.getAnyLocalizedValue(serviceHour.additionalInformation);if(additionalInformation){return result+' - '+additionalInformation}return result}else{if(serviceHour.openingHour.length===0&&!serviceHour.isClosed){return'('+type+') Aina avoinna (24/7)'}var openingHours=serviceHour.openingHour.map(function(openingHour){return _this.formatOpeningHour(openingHour)});return'('+type+') '+openingHours.join(',')}}},{key:'formatDateTime',value:function formatDateTime(dateTime){return moment(dateTime).locale('fi').format('lll')}},{key:'formatDate',value:function formatDate(date){return moment(date).locale('fi').format('ll')}},{key:'formatDateWithTime',value:function formatDateWithTime(date,time){var result=this.formatDate(date);if(time){return result+' '+time}return result}},{key:'formatDateWithTimes',value:function formatDateWithTimes(date,startTime,endTime){var start=this.formatDateWithTime(date,startTime);return endTime?start+' - '+endTime:start}},{key:'formatOpeningHour',value:function formatOpeningHour(dailyOpeningTime){if(dailyOpeningTime.dayFrom===null){return''}else{var result=this.getDayName(dailyOpeningTime.dayFrom,true);if(dailyOpeningTime.dayTo!==null&&dailyOpeningTime.dayTo!==dailyOpeningTime.dayFrom){result+=' - '+this.getDayName(dailyOpeningTime.dayTo,true)}if(dailyOpeningTime.from){result+=' '+dailyOpeningTime.from}if(dailyOpeningTime.to){result+=' - '+dailyOpeningTime.to}return result}}},{key:'saveServiceLocationServiceChannel',value:function saveServiceLocationServiceChannel(serviceLocationServiceChannel,callback){$.post(ajaxurl,{'action':'kunta_api_save_service_location_service_channel','serviceLocationServiceChannel':JSON.stringify(this.serviceLocationServiceChannel)},function(response){callback()}).fail(function(response){callback(response.responseText||response.statusText||'Unknown error occurred')})}},{key:'openMetaformDialog',value:function openMetaformDialog(viewModel,formValues,callback){var dialog=$('<div>').attr({'title':viewModel.title});var dialogContents=$('<div>').addClass('container-fluid').html(mfRender({viewModel:viewModel,formValues:formValues})).appendTo(dialog);$(dialog).dialog({modal:true,draggable:false,width:$(window).width()*0.9,height:$(window).height()*0.9,buttons:[{text:'Tallenna',click:function click(){var formValues={};$(dialog).find('form.metaform').metaform('val',true).forEach(function(value){formValues[value.name]=value.value});callback(formValues);$(dialog).dialog('close')}},{text:'Peruuta',click:function click(){$(dialog).dialog('close')}}]});$(dialog).find('form.metaform').metaform();return dialog}},{key:'openLocalizedMetaformDialog',value:function openLocalizedMetaformDialog(viewModel,formValues,callback){var _this2=this;var dialog=$('<div>').attr({'title':viewModel.title});var dialogContents=$('<div>').addClass('container-fluid').appendTo(dialog);var dialogTabs=$('<ul>').appendTo(dialogContents);this.supportedLocales.forEach(function(locale){var tabId='locale-tab-'+locale;$('<li>').appendTo(dialogTabs).append($('<a>').attr('href','#'+tabId).text(_this2.getLocaleName(locale)));$('<div>').attr('id',tabId).html(mfRender({viewModel:viewModel,formValues:formValues[locale]})).appendTo(dialogContents)});dialogContents.tabs();$(dialog).dialog({modal:true,draggable:false,width:$(window).width()*0.9,height:$(window).height()*0.9,buttons:[{text:'Tallenna',click:function click(){var formValues={};_this2.supportedLocales.forEach(function(locale){formValues[locale]={};$(dialog).find('#locale-tab-'+locale+' form.metaform').metaform('val',true).forEach(function(value){formValues[locale][value.name]=value.value})});callback(formValues)}},{text:'Peruuta',click:function click(){$(dialog).dialog('close')}}]});$(dialog).find('form.metaform').metaform();return dialog}},{key:'open',value:function open(){var _this3=this;var viewModel=getServiceLocationServiceChannelMetaform();var formValues={};this.supportedLocales.map(function(locale){formValues[locale]=_this3.serviceLocationServiceChannelToForm(locale,_this3.serviceLocationServiceChannel)});var dialog=this.openLocalizedMetaformDialog(viewModel,formValues,function(newFormValues){dialog.dialog('widget').addClass('loading');var updatedChannel=_this3.translateServiceLocationServiceChannelFromForm(_this3.serviceLocationServiceChannel,newFormValues);var validationError=_this3.validate(updatedChannel);if(validationError!==null){_this3.showError('Virheellinen sy\xF6te',validationError)}else{_this3.serviceLocationServiceChannel=updatedChannel;console.log(_this3.serviceLocationServiceChannel);_this3.saveServiceLocationServiceChannel(_this3.serviceLocationServiceChannel,function(err){dialog.dialog('widget').removeClass('loading');if(err){_this3.showError('Virhe tallentaessa',err)}else{dialog.dialog('close')}})}});$(dialog).on('click','.add-service-hour',this._onAddServiceHourClick.bind(this));$(dialog).on('click','.edit-service-hour',this._onEditServiceHourClick.bind(this));$(dialog).on('click','.remove-service-hour',this._onRemoveServiceHourClick.bind(this));this.redrawServiceHours()}},{key:'openServiceHourEditDialog',value:function openServiceHourEditDialog(serviceHour,callback){var _this4=this;var viewModel=getServiceHourMetaform();var formValues=this.serviceHourToForm(serviceHour);var dialog=this.openMetaformDialog(this.prepareViewModel(viewModel),formValues,function(newFormValues){var updatedServiceHour=_this4.serviceHourFromForm(newFormValues);callback(updatedServiceHour)})}},{key:'showError',value:function showError(title,text){var contents=$('<div>').addClass('error').text(text);var dialog=$('<div>').attr('title',title).append(contents).dialog({modal:true,draggable:false,width:600,height:350,buttons:{Ok:function Ok(){$(dialog).dialog('close')}}})}},{key:'validate',value:function validate(serviceLocationServiceChannel){var addressSubtypes=[];for(var j=0;j<serviceLocationServiceChannel.addresses.length;j++){var address=serviceLocationServiceChannel.addresses[j];if(address.subtype==='Abroad'||address.subtype==='Single'){for(var i=0;i<addressSubtypes.length;i++){if(addressSubtypes[i]!==address.subtype){return'Toimipisteell\xE4 ei voi olla yht\xE4aikaa kotimaista ja ulkomaista osoitetta'}}}addressSubtypes.push(address.subtype)}return null}},{key:'redrawServiceHours',value:function redrawServiceHours(){var _this5=this;var serviceHourTexts=this.serviceLocationServiceChannel.serviceHours.map(function(serviceHour){return _this5.formatServiceHour(serviceHour)});$('table.serviceHours tbody').empty();if(serviceHourTexts.length){serviceHourTexts.forEach(function(serviceHourText){var row=$('<tr>').appendTo($('table.serviceHours tbody'));$('<td>').html(serviceHourText).appendTo(row);$('<td>').append($('<a>').addClass('btn btn-sm btn-warning remove-service-hour').html('Poista')).appendTo(row);$('<td>').append($('<a>').addClass('btn btn-sm btn-success edit-service-hour').html('Muokkaa')).appendTo(row)})}else{$('<tr>').append($('<td>').html('Palveluaikoja ei ole viel\xE4 m\xE4\xE4ritelty')).appendTo($('table.serviceHours tbody'))}}},{key:'getTypedLocalizedValue',value:function getTypedLocalizedValue(values,locale,type){if(!values){return null}for(var i=0;i<values.length;i++){if(locale===values[i].language&&type===values[i].type){return values[i].value}}return null}},{key:'getLocalizedValue',value:function getLocalizedValue(values,locale){if(!values){return null}for(var i=0;i<values.length;i++){if(locale===values[i].language){return values[i].value}}return null}},{key:'getAnyLocalizedValue',value:function getAnyLocalizedValue(values){for(var i=0;i<this.supportedLocales.length;i++){var result=this.getLocalizedValue(values,this.supportedLocales[i]);if(result){return result}}return null}},{key:'prepareViewModel',value:function prepareViewModel(viewModel){var _this6=this;(viewModel.sections||[]).forEach(function(section){(section.fields||[]).forEach(function(field,index){var localeVariableIndex=field.name.indexOf('{LOCALE}');if(localeVariableIndex!==-1){section.fields.splice(index,1);_this6.supportedLocales.forEach(function(locale){section.fields.splice(index,0,Object.assign({},field,{name:field.name.replace(/\{LOCALE\}/g,locale),title:field.title.replace(/\{LOCALE\}/g,_this6.getLocaleName(locale))}))})}})});return viewModel}},{key:'serviceHourFromFormException',value:function serviceHourFromFormException(formValues){var additionalInformation=[];var isClosed=formValues.type==='closed-all-day';var validForNow=false;var toTime=isClosed?null:formValues['Exception-to-time'];var fromTime=isClosed?null:formValues['Exception-from-time'];var openingHour=[];if(toTime||fromTime){openingHour.push({dayFrom:null,dayTo:null,from:fromTime,to:toTime,isExtra:false})}this.supportedLocales.forEach(function(locale){var value=formValues['Exception-additional-information-'+locale];if(value){additionalInformation.push({language:locale,value:value})}});return{serviceHourType:formValues.type,validFrom:this.parseIsoDate(formValues['Exception-from-date']),validTo:this.parseIsoDate(formValues['Exception-to-date']),isClosed:isClosed,validForNow:validForNow,additionalInformation:additionalInformation,openingHour:openingHour}}},{key:'serviceHourFromFormStandard',value:function serviceHourFromFormStandard(formValues){var isClosed=false;var validForNow=formValues[formValues.type+'-validForNow']==='true';var additionalInformation=[];var serviceHours=JSON.parse(formValues['Standard-openinghours']);var openingHour=formValues['Standard-open24h']?[]:serviceHours.map(function(serviceHour){return{dayFrom:parseInt(serviceHour.day),dayTo:parseInt(serviceHour.day),from:serviceHour.from,to:serviceHour.to,isExtra:false}});return{serviceHourType:formValues.type,validFrom:validForNow?null:this.parseIsoDate(formValues[formValues.type+'-validFrom']),validTo:validForNow?null:this.parseIsoDate(formValues[formValues.type+'-validTo']),isClosed:isClosed,validForNow:validForNow,additionalInformation:additionalInformation,openingHour:openingHour}}},{key:'serviceHourFromFormSpecial',value:function serviceHourFromFormSpecial(formValues){var isClosed=false;var validForNow=formValues[formValues.type+'-validForNow']==='true';var additionalInformation=[];var openingHour=[{dayFrom:parseInt(formValues['Special-from-date']),dayTo:parseInt(formValues['Special-to-date']),from:formValues['Special-from-time'],to:formValues['Special-to-time'],isExtra:false}];return{serviceHourType:formValues.type,validFrom:validForNow?null:this.parseIsoDate(formValues[formValues.type+'-validFrom']),validTo:validForNow?null:this.parseIsoDate(formValues[formValues.type+'-validTo']),isClosed:isClosed,validForNow:validForNow,additionalInformation:additionalInformation,openingHour:openingHour}}},{key:'serviceHourFromForm',value:function serviceHourFromForm(formValues){var serviceHourType=formValues.type;switch(serviceHourType){case'Exception':return this.serviceHourFromFormException(formValues);case'Standard':return this.serviceHourFromFormStandard(formValues);case'Special':return this.serviceHourFromFormSpecial(formValues);};}},{key:'translateServiceLocationServiceChannelFromForm',value:function translateServiceLocationServiceChannelFromForm(existingLocationServiceChannel,formValues){var serviceLocationServiceChannel=JSON.parse(JSON.stringify(existingLocationServiceChannel));serviceLocationServiceChannel.addresses=[];serviceLocationServiceChannel.descriptions=[];serviceLocationServiceChannel.emails=[];this.supportedLocales.forEach(function(locale){var localeValues=formValues[locale];var localeAddresses=JSON.parse(localeValues.addresses).filter(function(address){return!!address.street&&!!address.street.trim()});localeAddresses.forEach(function(localeAddress,addressIndex){var address=void 0;if(serviceLocationServiceChannel.addresses.length-1<addressIndex){address={additionalInformations:[],streetAddress:[],subtype:'Single',type:'Location',country:'FI'};serviceLocationServiceChannel.addresses.push(address)}else{address=serviceLocationServiceChannel.addresses[addressIndex]}if(localeAddress.additionalInformation){localeAddress.additionalInformation=localeAddress.additionalInformation.trim()}if(localeAddress.additionalInformation){address.additionalInformations.push({'language':locale,'value':localeAddress.additionalInformation})}address.streetAddress.push({'language':locale,'value':localeAddress.street});address.postalCode=localeAddress.postOfficeCode;address.streetNumber=localeAddress.streetNumber});var foreignAddresses=JSON.parse(localeValues.foreignAddresses).filter(function(address){return!!address.foreign});foreignAddresses.forEach(function(foreignAddress,foreignAddressIndex){var addressIndex=localeAddresses.length+foreignAddressIndex;var address=void 0;if(serviceLocationServiceChannel.addresses.length-1<addressIndex){address={subtype:'Abroad',type:'Location',locationAbroad:[]};serviceLocationServiceChannel.addresses.push(address)}else{address=serviceLocationServiceChannel.addresses[addressIndex]}address.locationAbroad.push({'language':locale,'value':foreignAddress.foreign})});serviceLocationServiceChannel.emails=serviceLocationServiceChannel.emails.concat(JSON.parse(localeValues.emails).filter(function(email){return!!email.email}).map(function(email){return{'language':locale,'value':email.email}}));if(localeValues.description){localeValues.description=localeValues.description.trim()}if(localeValues.description){serviceLocationServiceChannel.descriptions.push({'language':locale,'value':localeValues.description,'type':'Description'})}if(localeValues.shortDescription){localeValues.shortDescription=localeValues.shortDescription.trim()}if(localeValues.shortDescription){serviceLocationServiceChannel.descriptions.push({'language':locale,'value':localeValues.shortDescription,'type':'ShortDescription'})}});return serviceLocationServiceChannel}},{key:'serviceHourToForm',value:function serviceHourToForm(serviceHour){var _this7=this;if(!serviceHour){return{}}var type=serviceHour.serviceHourType;var validForNow=serviceHour.validForNow?'true':'false';var validFrom=serviceHour.validForNow||!serviceHour.validFrom?null:moment(serviceHour.validFrom);var validTo=serviceHour.validForNow||!serviceHour.validTo?null:moment(serviceHour.validTo);var open24h=serviceHour.openingHour.length===0&&!serviceHour.isClosed;var validFromStr=validFrom?validFrom.format():null;var validToStr=validTo?validTo.format():null;var openingHour=serviceHour.openingHour&&serviceHour.openingHour.length?serviceHour.openingHour[0]:null;var openingHours=[];(serviceHour.openingHour||[]).forEach(function(openingHour){for(var day=openingHour.dayFrom;day<=openingHour.dayTo;day++){openingHours.push({day:day,from:openingHour.from,to:openingHour.to})};});switch(type){case'Standard':return{'type':type,'Standard-validForNow':validForNow,'Standard-validFrom':validFromStr,'Standard-validTo':validToStr,'Standard-open24h':open24h,'Standard-openinghours':openingHours};case'Special':return{'type':type,'Special-validForNow':validForNow,'Special-validFrom':validFromStr,'Special-validTo':validToStr,'Special-from-date':openingHour?openingHour.dayFrom:null,'Special-from-time':openingHour?openingHour.from:null,'Special-to-date':openingHour?openingHour.dayTo:null,'Special-to-time':openingHour?openingHour.to:null};case'Exception':var openFrom=openingHour?openingHour.from:null;var openTo=openingHour?openingHour.to:null;var exceptionType=!validTo?!openFrom&&!openTo?'closed-all-day':'single':'range';if(validFrom&&openFrom){var parts=openFrom.split(':');validFrom.hour(parseInt(parts[0]));validFrom.minute(parseInt(parts[1]))}if(validTo&&openTo){var _parts=openTo.split(':');validTo.hour(parseInt(_parts[0]));validTo.minute(parseInt(_parts[1]))}var result={'type':type,'Exception-type':exceptionType,'Exception-from-date':validFrom?validFrom.format():null,'Exception-to-date':validTo?validTo.format():null,'Exception-from-time':openFrom,'Exception-to-time':openTo};this.supportedLocales.forEach(function(locale){result['Exception-additional-information-'+locale]=_this7.getLocalizedValue(serviceHour.additionalInformation,locale)});return result;default:throw new Error('Unknown service hour type '+type);break;}}},{key:'serviceLocationServiceChannelToForm',value:function serviceLocationServiceChannelToForm(locale,serviceLocationServiceChannel){var _this8=this;var name=this.getTypedLocalizedValue(serviceLocationServiceChannel.names,locale,'Name');var shortDescription=this.getTypedLocalizedValue(serviceLocationServiceChannel.descriptions,locale,'ShortDescription');var description=this.getTypedLocalizedValue(serviceLocationServiceChannel.descriptions,locale,'Description');var visitAddresses=serviceLocationServiceChannel.addresses.filter(function(address){return address.subtype!=='Abroad'});var foreignAddresses=serviceLocationServiceChannel.addresses.filter(function(address){return address.subtype==='Abroad'});var addresses=visitAddresses.map(function(address){return{street:_this8.getLocalizedValue(address.streetAddress,locale),streetNumber:address.streetNumber,postOfficeCode:address.postalCode,additionalInformation:_this8.getLocalizedValue(address.additionalInformations,locale)}});var serviceHours=serviceLocationServiceChannel.serviceHours.map(function(serviceHour){return'TODO'});return{name:name,description:description,shortDescription:shortDescription,addresses:addresses,foreignAddresses:foreignAddresses.map(function(foreignAddress){return{foreign:_this8.getLocalizedValue(foreignAddress.locationAbroad,locale)}}),serviceHours:serviceHours}}},{key:'parseIsoDate',value:function parseIsoDate(string){if(!string){return null}return new Date(Date.parse(string))}},{key:'trigger',value:function trigger(event,data){this.listeners.forEach(function(listener){if(listener.event===event){listener.callable(data||{})}})}},{key:'on',value:function on(event,callable){this.listeners.push({event:event,callable:callable})}},{key:'_onAddServiceHourClick',value:function _onAddServiceHourClick(event){var _this9=this;this.openServiceHourEditDialog(null,function(createdServiceHour){_this9.serviceLocationServiceChannel.serviceHours.push(createdServiceHour);_this9.redrawServiceHours()})}},{key:'_onEditServiceHourClick',value:function _onEditServiceHourClick(event){var _this10=this;var row=$(event.target).closest('tr');var index=row.index();var serviceHour=this.serviceLocationServiceChannel.serviceHours[index];this.openServiceHourEditDialog(serviceHour,function(updatedServiceHour){_this10.serviceLocationServiceChannel.serviceHours.splice(index,1,updatedServiceHour);_this10.redrawServiceHours()})}},{key:'_onRemoveServiceHourClick',value:function _onRemoveServiceHourClick(event){var row=$(event.target).closest('tr');var index=row.index();this.serviceLocationServiceChannel.serviceHours.splice(index,1);this.redrawServiceHours()}}]);return ServiceLocationServiceChannelDialog}();var ServiceLocationServiceChannelEditor=function(){function ServiceLocationServiceChannelEditor(editor){_classCallCheck(this,ServiceLocationServiceChannelEditor);this.buttonStyle={'color':'#555','width':'100%','border':'1px solid #ccc','background':'#f7f7f7','display':'block','padding':'5px','margin-top':'5px','margin-bottom':'5px','cursor':'pointer'};this.editor=editor;this.editor.on('BeforeSetcontent',this.onBeforeSetcontent.bind(this));this.editor.on('GetContent',this.onGetContent.bind(this));this.editor.on('DblClick',this.onDblClick.bind(this));this.editor.addCommand('kunta-api-service-location-channel-edit',this.onServiceLocationChannelEdit.bind(this))}_createClass(ServiceLocationServiceChannelEditor,[{key:'parseAttributes',value:function parseAttributes(string){var result=[];var re=/([a-zA-Z-_]*)(\=\")([a-zA-Z0-9-]*)(\")/g;var match=null;do{match=re.exec(string);if(match&&match.length>3){result.push({name:match[1],value:match[3]})}}while(match);return result}},{key:'getComponentTitle',value:function getComponentTitle(name){return SUPPORTED_COMPONENTS[name].title}},{key:'replaceShortcodes',value:function replaceShortcodes(content){var _this11=this;return content.replace(/(\[kunta_api_location_channel_component)([a-zA-Z0-9 -=]*)(\])/g,function(all,tag,attributesText,end){var attributes=_this11.parseAttributes(attributesText);var placeholder=$('<input>').attr({'type':'button','data-kunta-api-placeholder':'location_channel_component'}).css(_this11.buttonStyle);for(var i=0;i<attributes.length;i++){var attribute=attributes[i];placeholder.attr('data-'+attribute.name,attribute.value)}var component=placeholder.attr('data-component');if(!SUPPORTED_COMPONENTS[component]){return all}placeholder.attr('value',_this11.getComponentTitle(component));return $('<div>').append(placeholder).html()})}},{key:'restoreShortcodes',value:function restoreShortcodes(content){return content.replace(/<input [^>]+>/g,function(match){var input=$(match);if(input.attr('data-kunta-api-placeholder')==='location_channel_component'){var shortcodeAttributes=[];var attributeNames=['channel-id','component'];for(var i=0;i<attributeNames.length;i++){var attributeName=attributeNames[i];var attributeValue=input.attr('data-'+attributeName);shortcodeAttributes.push([attributeName,'"'+attributeValue+'"'].join('='))}return'[kunta_api_location_channel_component '+shortcodeAttributes.join(' ')+']'}return match})}},{key:'openElementEditor',value:function openElementEditor(element){var placeholderAttr=element.attributes['data-kunta-api-placeholder'];if(placeholderAttr){var serviceLocationServiceChannelId=element.attributes['data-channel-id'].value;this.editor.execCommand('kunta-api-service-location-channel-edit','',{serviceLocationServiceChannelId:serviceLocationServiceChannelId})}}},{key:'findServiceLocationServiceChannel',value:function findServiceLocationServiceChannel(id,callback){$.post(ajaxurl,{'action':'kunta_api_load_service_location_service_channel','serviceLocationServiceChannelId':id},function(response){callback(null,JSON.parse(response))}).fail(function(response){callback(response.responseText||response.statusText)})}},{key:'onBeforeSetcontent',value:function onBeforeSetcontent(event){event.content=this.replaceShortcodes(event.content)}},{key:'onGetContent',value:function onGetContent(event){event.content=this.restoreShortcodes(event.content)}},{key:'onDblClick',value:function onDblClick(event){var element=event.target;this.openElementEditor(element)}},{key:'onServiceLocationChannelEdit',value:function onServiceLocationChannelEdit(ui,options){var _this12=this;this.findServiceLocationServiceChannel(options.serviceLocationServiceChannelId,function(err,serviceLocationServiceChannel){if(err){tinyMCE.activeEditor.windowManager.alert(err)}else{var dialog=new ServiceLocationServiceChannelDialog(_this12.editor,serviceLocationServiceChannel);dialog.open()}})}}]);return ServiceLocationServiceChannelEditor}();var ServiceLocationServiceChannelEmbed=function(){function ServiceLocationServiceChannelEmbed(editor){_classCallCheck(this,ServiceLocationServiceChannelEmbed);this.editor=editor;this.displayLocale='fi';this.searching=false;this.pending=false;this.addButton()}_createClass(ServiceLocationServiceChannelEmbed,[{key:'addButton',value:function addButton(){var _this13=this;this.editor.addButton('kunta_api_service_location_embed',{title:'Search Kunta API service location channels',onclick:function onclick(){_this13.editor.windowManager.open({title:'Search Kunta API service location channels',width:768,height:500,body:[{type:'textbox',name:'kunta-api-service-query',label:'Query',onKeyUp:function onKeyUp(e){if(!_this13.searching){_this13.searching=true;_this13.searchServiceLocationChannels(e.target.value,function(response){_this13.searching=false;if(_this13.pending){_this13.searchServiceLocationChannels(e.target.value,function(innerResponse){_this13.handleResponse(innerResponse)})}else{_this13.handleResponse(response)}})}else{_this13.pending=true}}},{type:'label',classes:'kunta-api-search-info',text:'Kirjoita hakusana yll\xE4 olevaan hakukentt\xE4\xE4n'},{type:'container',classes:'kunta-api-search-results',minHeight:400}],onsubmit:function onsubmit(e){var responseHtml='';var allEmbedsFromSameChannel=true;var componentsToEmbed=$('.service-component-embed-input:checked');var firstServiceLocationChannelId=componentsToEmbed.first().attr('data-service-location-channel-id');var serviceLocationChannelName=componentsToEmbed.first().attr('data-service-location-channel-name');componentsToEmbed.each(function(){var component=$(this).attr('data-component-type');var serviceLocationChannelId=$(this).attr('data-service-location-channel-id');responseHtml+='[kunta_api_location_channel_component channel-id="'+serviceLocationChannelId+'" component="'+component+'"]';if(serviceLocationChannelId!==firstServiceLocationChannelId){allEmbedsFromSameChannel=false}});if(allEmbedsFromSameChannel){_this13.editor.windowManager.confirm('Merkit\xE4\xE4nk\xF6 sivu palvelukanavan: '+serviceLocationChannelName+' sivuksi?',function(confirmed){if(confirmed){var pageId=$('#post_ID').val();this.markAsServiceLocationPage(firstServiceLocationChannelId,pageId)}})}_this13.editor.insertContent(responseHtml)}})}})}},{key:'markAsServiceLocationPage',value:function markAsServiceLocationPage(serviceLocationChannelId,pageId){$.post(ajaxurl,{'action':'kunta_api_mark_page_as_location_page','pageId':pageId,'locationChannelId':serviceLocationChannelId},function(response){})}},{key:'searchServiceLocationChannels',value:function searchServiceLocationChannels(query,callback){$('.mce-kunta-api-search-results').empty();$('.mce-kunta-api-search-results').append($('<div>').addClass('mce-kunta-api-search-results-loader'));$('.mce-kunta-api-search-info').text('Ladataan...');$.post(ajaxurl,{'action':'kunta_api_search_service_location_channels','data':query},function(response){$('.mce-kunta-api-search-results-loader').remove();callback(JSON.parse(response))})}},{key:'getLocalizedValueAndType',value:function getLocalizedValueAndType(values,locale,type){for(var i=0;i<values.length;i++){if(locale===values[i].language&&type===values[i].type){return values[i].value}}return null}},{key:'appendResult',value:function appendResult(result){var resultContainer=$('<div>').addClass('mce-kunta-api-search-result-row');var name=this.getLocalizedValueAndType(result.names,this.displayLocale,'Name');resultContainer.append($('<p>').addClass('mce-kunta-api-search-result-title').text(name));Object.keys(SUPPORTED_COMPONENTS).forEach(function(component){var options=SUPPORTED_COMPONENTS[component];resultContainer.append($('<p>').append($('<input>').addClass('service-component-embed-input').attr({'type':'checkbox','data-service-location-channel-name':name,'data-component-type':component,'data-service-location-channel-id':result.id})).append($('<span>').text(options.title)))});$('.mce-kunta-api-search-results').append(resultContainer)}},{key:'handleResponse',value:function handleResponse(response){$('.mce-kunta-api-search-results').empty();if(response.length===0){$('.mce-kunta-api-search-info').text('Hakusanalla ei l\xF6ytynyt yht\xE4\xE4n palvelua')}else{$('.mce-kunta-api-search-info').text('Kirjoita hakusana yll\xE4 olevaan hakukentt\xE4\xE4n')}for(var i=0;i<response.length;i++){this.appendResult(response[i])}}}]);return ServiceLocationServiceChannelEmbed}();tinymce.PluginManager.add('kunta_api_service_location_embed',function(editor,url){new ServiceLocationServiceChannelEmbed(editor);new ServiceLocationServiceChannelEditor(editor)})})(tinymce,jQuery);
//# sourceMappingURL=plugin.js.map
