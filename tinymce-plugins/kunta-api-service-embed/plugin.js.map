{"version":3,"sources":["../src/kunta-api-service-embed/js/plugin.js"],"names":["tinymce","$","SUPPORTED_COMPONENTS","ServiceDialog","editor","service","callback","post","ajaxurl","JSON","stringify","response","fail","responseText","statusText","serviceLocationServiceChannel","window","KuntaApiAbstractEditDialog","ServiceEditor","buttonStyle","on","onBeforeSetcontent","bind","onGetContent","onDblClick","addCommand","onServiceEdit","string","result","re","match","exec","length","push","name","value","title","content","replace","all","tag","attributesText","end","attributes","parseAttributes","placeholder","attr","css","i","attribute","component","getComponentTitle","append","html","input","shortcodeAttributes","attributeNames","attributeName","attributeValue","join","element","placeholderAttr","serviceId","execCommand","id","parse","event","replaceShortcodes","restoreShortcodes","target","openElementEditor","ui","options","findService","err","tinyMCE","activeEditor","windowManager","alert","dialog","open","ServiceEmbed","displayLocale","searching","pending","addButton","onclick","width","height","body","type","label","onKeyUp","e","searchServices","innerResponse","handleResponse","classes","text","minHeight","onsubmit","responseHtml","allEmbedsFromSameChannel","componentsToEmbed","each","insertContent","query","empty","addClass","remove","values","locale","language","resultContainer","getLocalizedValueAndType","names","Object","keys","forEach","appendResult","PluginManager","add","url","jQuery"],"mappings":"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","file":"plugin.js","sourcesContent":["/* jshint esversion: 6 */\n/* global ajaxurl, tinymce, moment, Promise */\n((tinymce, $) => {\n  \n  const SUPPORTED_COMPONENTS = {\n    'description': {\n      'title': 'Palvelun kuvaus'\n    },\n    'userInstruction': {\n      'title': 'Palvelun toimintaohjeet'\n    },\n    'languages': {\n      'title': 'Palvelun kielet'\n    },\n    'electronicServiceChannelIds': {\n      'title': 'Palvelun sähköiset palvelukanavat'\n    },\n    'phoneServiceChannelIds': {\n      'title': 'Palvelun puhelinpalvelukanavat'\n    },\n    'printableFormServiceChannelIds': {\n      'title': 'Palveluun liittyvät lomakkeet'\n    },\n    'serviceLocationServiceChannelIds': {\n      'title': 'Palvelun toimipisteet'\n    },\n    'webPageServiceChannelIds': {\n      'title': 'Palvelun hyödylliset linkit'\n    }\n  };\n  \n  class ServiceDialog extends window.KuntaApiAbstractEditDialog {\n    \n    /**\n     * Constructs edit dialog\n     * \n     * @param {type} editor TinyMCE editor instance\n     * @param {type} service\n     */\n    constructor(editor, service) {\n      super(editor);\n      this.service = service;\n    }\n    \n    saveService(service, callback) {\n      $.post(ajaxurl, {\n        'action': 'kunta_api_save_service',\n        'service': JSON.stringify(this.service)\n      }, (response) => {\n        callback();\n      })\n      .fail((response) => {\n        callback(response.responseText || response.statusText || \"Unknown error occurred\");\n      });\n    }\n    \n    open() {\n      \n    }\n    \n    validate(serviceLocationServiceChannel) {\n      return null;\n    }\n    \n  }\n  \n  class ServiceEditor {\n    \n    constructor (editor) {\n      this.buttonStyle = {\n        'color': '#555',\n        'width': '100%',\n        'border': '1px solid #ccc',\n        'background': '#f7f7f7',\n        'display': 'block',\n        'padding': '5px',\n        'margin-top': '5px',\n        'margin-bottom': '5px',\n        'cursor': 'pointer'\n      };\n      \n      this.editor = editor;\n      \n      this.editor.on('BeforeSetcontent', this.onBeforeSetcontent.bind(this));\n      this.editor.on('GetContent', this.onGetContent.bind(this));\n      this.editor.on('DblClick', this.onDblClick.bind(this));\n      this.editor.addCommand('kunta-api-service-edit', this.onServiceEdit.bind(this));\n    }\n    \n    parseAttributes (string) {\n      const result = [];\n      const re = /([a-zA-Z-_]*)(\\=\\\")([a-zA-Z0-9-]*)(\\\")/g;\n      let match = null;\n      \n      do {\n        match = re.exec(string);\n        if (match && match.length > 3) {\n          result.push({\n            name: match[1],\n            value: match[3] \n          });\n        }\n      } while (match);\n\n      return result;\n    }\n    \n    getComponentTitle (name) {\n      return SUPPORTED_COMPONENTS[name].title;\n    }\n    \n    replaceShortcodes(content) {\n      return content.replace(/(\\[kunta_api_service_component)([a-zA-Z0-9 -=]*)(\\])/g, (all, tag, attributesText, end) => {\n        const attributes = this.parseAttributes(attributesText);\n        const placeholder = $('<input>')\n          .attr({\n           'type': 'button',\n           'data-kunta-api-placeholder': 'service'\n          })\n          .css(this.buttonStyle);\n          \n        for (let i = 0; i < attributes.length; i++) {\n          const attribute = attributes[i];\n          placeholder.attr('data-' + attribute.name, attribute.value);\n        }\n        \n        const component = placeholder.attr('data-component');\n        if (!SUPPORTED_COMPONENTS[component]) {\n          return all;\n        }\n        \n        placeholder.attr('value', this.getComponentTitle(component));\n        return $('<div>').append(placeholder).html();\n      });\n      \n    }\n    \n    restoreShortcodes(content) {\n      return content.replace(/<input [^>]+>/g, (match) => {\n        const input = $(match);\n        \n        if (input.attr('data-kunta-api-placeholder') === 'service') {\n          const shortcodeAttributes = [];\n          const attributeNames = ['service-id', 'component'];\n          \n          for (let i = 0; i < attributeNames.length; i++) {\n            const attributeName = attributeNames[i];\n            const attributeValue = input.attr('data-' + attributeName);\n            shortcodeAttributes.push([attributeName, '\"' + attributeValue + '\"'].join('='));\n          }\n          \n          return '[kunta_api_service_component ' + shortcodeAttributes.join(' ') + ']';\n        }\n        \n        return match;\n      });\n    }\n    \n    openElementEditor(element) {\n      const placeholderAttr = element.attributes['data-kunta-api-placeholder'];\n      if (placeholderAttr) {\n        const serviceId = element.attributes['data-service-id'].value;\n        this.editor.execCommand('kunta-api-service-edit', '', {\n          serviceId: serviceId\n        });\n      }\n    }\n    \n    findService(id, callback) {\n      $.post(ajaxurl, {\n        'action': 'kunta_api_load_service',\n        'serviceId': id\n      }, (response) => {\n        callback(null, JSON.parse(response));\n      })\n      .fail((response) => {\n        callback(response.responseText || response.statusText);\n      });\n    }\n    \n    onBeforeSetcontent(event) {\n      event.content = this.replaceShortcodes(event.content);\n    }\n    \n    onGetContent(event) {\n      event.content = this.restoreShortcodes(event.content);\n    }\n    \n    onDblClick(event) {\n      const element = event.target;\n      this.openElementEditor(element);\n    }\n\n    onServiceEdit(ui, options) {\n      this.findService(options.serviceId, (err, service) => {\n        if (err) {\n          tinyMCE.activeEditor.windowManager.alert(err);\n        } else {\n          const dialog = new ServiceDialog(this.editor, service);\n          dialog.open();\n        }\n      });\n    } \n    \n  }\n  \n  class ServiceEmbed {\n    \n    constructor (editor) {\n      this.editor = editor;\n      this.displayLocale = 'fi';\n      this.searching = false;\n      this.pending = false;\n      this.addButton();\n    }\n    \n    addButton () {\n      this.editor.addButton('kunta_api_service_embed', {\n        title: 'Search Kunta API services',\n        onclick: () => {\n          this.editor.windowManager.open({\n            title: 'Search Kunta API services',\n            width: 768,\n            height: 500,\n            body: [\n              { type: 'textbox', name: 'kunta-api-service-query', label: 'Query', onKeyUp: (e) => {     \n                if (!this.searching) {\n                  this.searching = true;\n                  this.searchServices(e.target.value, (response) => {\n                    this.searching = false;\n                    if (this.pending) {\n                      this.searchServices(e.target.value, (innerResponse) => {\n                        this.handleResponse(innerResponse);\n                      });\n                    } else {\n                      this.handleResponse(response);\n                    }\n                  });\n                } else {\n                  this.pending = true;\n                }\n              }},\n              {type: 'label', classes: 'kunta-api-search-info', text: \"Kirjoita hakusana yllä olevaan hakukenttään\"},\n              {type: 'container', classes: 'kunta-api-search-results', minHeight: 400}\n            ],\n            onsubmit: (e) => {\n              let responseHtml = '';\n              let allEmbedsFromSameChannel = true;              \n              const componentsToEmbed = $('.service-component-embed-input:checked');\n              \n              componentsToEmbed.each(function () {\n                var component = $(this).attr('data-component-type');\n                var serviceId = $(this).attr('data-service-id');\n                responseHtml += '[kunta_api_service_component service-id=\"'+ serviceId +'\" component=\"'+ component +'\"]';\n              });\n\n              this.editor.insertContent(responseHtml);\n            }\n          });\n        }\n      });\n    }\n    \n    searchServices(query, callback) {\n      $('.mce-kunta-api-search-results').empty();\n      $('.mce-kunta-api-search-results').append($('<div>').addClass('mce-kunta-api-search-results-loader'));\n      $('.mce-kunta-api-search-info').text('Ladataan...');\n      $.post(ajaxurl, {\n        'action': 'kunta_api_search_services',\n        'data': query\n      }, (response) => {\n        $('.mce-kunta-api-search-results-loader').remove();\n        callback(JSON.parse(response));\n      });\n    }\n    \n    getLocalizedValueAndType(values, locale, type) {\n      for (let i = 0; i < values.length; i++) {\n        if (locale === values[i].language && type === values[i].type) {\n          return values[i].value;\n        }\n      }\n      \n      return null;\n    }\n    \n    appendResult(result) {\n      const resultContainer = $('<div>').addClass('mce-kunta-api-search-result-row');\n      const name = this.getLocalizedValueAndType(result.names, this.displayLocale, 'Name');\n\n      resultContainer.append(\n        $('<p>')\n          .addClass('mce-kunta-api-search-result-title')\n          .text(name)\n      );\n      \n      Object.keys(SUPPORTED_COMPONENTS).forEach((component) => {\n        const options = SUPPORTED_COMPONENTS[component]; \n        resultContainer.append(\n          $('<p>')\n            .append($('<input>')\n            .addClass('service-component-embed-input')\n            .attr({\n              'type':'checkbox',\n              'data-component-type': component,\n              'data-service-id': result.id\n            }))\n            .append($('<span>').text(options.title))\n        );\n      });\n      \n      $('.mce-kunta-api-search-results').append(resultContainer);\n    }\n    \n    handleResponse(response) {\n      $('.mce-kunta-api-search-results').empty();\n\n      if (response.length === 0) {\n        $('.mce-kunta-api-search-info').text('Hakusanalla ei löytynyt yhtään palvelua');\n      } else {\n        $('.mce-kunta-api-search-info').text('Kirjoita hakusana yllä olevaan hakukenttään');\n      }\n\n      for (let i = 0; i < response.length; i++) {\n        this.appendResult(response[i]);\n      }\n\n    }\n    \n  }\n  \n  tinymce.PluginManager.add('kunta_api_service_embed', (editor, url) => {\n    new ServiceEmbed(editor);\n    new ServiceEditor(editor);\n  });\n  \n})(tinymce, jQuery);"]}