'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}/* jshint esversion: 6 *//* global ajaxurl, tinymce, moment, Promise */(function(tinymce,$){var SUPPORTED_COMPONENTS={'description':{'title':'Palvelun kuvaus'},'userInstruction':{'title':'Palvelun toimintaohjeet'},'languages':{'title':'Palvelun kielet'},'electronicServiceChannelIds':{'title':'Palvelun s\xE4hk\xF6iset palvelukanavat'},'phoneServiceChannelIds':{'title':'Palvelun puhelinpalvelukanavat'},'printableFormServiceChannelIds':{'title':'Palveluun liittyv\xE4t lomakkeet'},'serviceLocationServiceChannelIds':{'title':'Palvelun toimipisteet'},'webPageServiceChannelIds':{'title':'Palvelun hy\xF6dylliset linkit'}};var ServiceDialog=function(_window$KuntaApiAbstr){_inherits(ServiceDialog,_window$KuntaApiAbstr);/**
     * Constructs edit dialog
     * 
     * @param {type} editor TinyMCE editor instance
     * @param {type} service
     */function ServiceDialog(editor,service){_classCallCheck(this,ServiceDialog);var _this=_possibleConstructorReturn(this,(ServiceDialog.__proto__||Object.getPrototypeOf(ServiceDialog)).call(this,editor));_this.service=service;return _this}_createClass(ServiceDialog,[{key:'saveService',value:function saveService(service,callback){$.post(ajaxurl,{'action':'kunta_api_save_service','service':JSON.stringify(this.service)},function(response){callback()}).fail(function(response){callback(response.responseText||response.statusText||'Unknown error occurred')})}},{key:'open',value:function open(){}},{key:'validate',value:function validate(serviceLocationServiceChannel){return null}}]);return ServiceDialog}(window.KuntaApiAbstractEditDialog);var ServiceEditor=function(){function ServiceEditor(editor){_classCallCheck(this,ServiceEditor);this.buttonStyle={'color':'#555','width':'100%','border':'1px solid #ccc','background':'#f7f7f7','display':'block','padding':'5px','margin-top':'5px','margin-bottom':'5px','cursor':'pointer'};this.editor=editor;this.editor.on('BeforeSetcontent',this.onBeforeSetcontent.bind(this));this.editor.on('GetContent',this.onGetContent.bind(this));this.editor.on('DblClick',this.onDblClick.bind(this));this.editor.addCommand('kunta-api-service-edit',this.onServiceEdit.bind(this))}_createClass(ServiceEditor,[{key:'parseAttributes',value:function parseAttributes(string){var result=[];var re=/([a-zA-Z-_]*)(\=\")([a-zA-Z0-9-]*)(\")/g;var match=null;do{match=re.exec(string);if(match&&match.length>3){result.push({name:match[1],value:match[3]})}}while(match);return result}},{key:'getComponentTitle',value:function getComponentTitle(name){return SUPPORTED_COMPONENTS[name].title}},{key:'replaceShortcodes',value:function replaceShortcodes(content){var _this2=this;return content.replace(/(\[kunta_api_service_component)([a-zA-Z0-9 -=]*)(\])/g,function(all,tag,attributesText,end){var attributes=_this2.parseAttributes(attributesText);var placeholder=$('<input>').attr({'type':'button','data-kunta-api-placeholder':'service'}).css(_this2.buttonStyle);for(var i=0;i<attributes.length;i++){var attribute=attributes[i];placeholder.attr('data-'+attribute.name,attribute.value)}var component=placeholder.attr('data-component');if(!SUPPORTED_COMPONENTS[component]){return all}placeholder.attr('value',_this2.getComponentTitle(component));return $('<div>').append(placeholder).html()})}},{key:'restoreShortcodes',value:function restoreShortcodes(content){return content.replace(/<input [^>]+>/g,function(match){var input=$(match);if(input.attr('data-kunta-api-placeholder')==='service'){var shortcodeAttributes=[];var attributeNames=['service-id','component'];for(var i=0;i<attributeNames.length;i++){var attributeName=attributeNames[i];var attributeValue=input.attr('data-'+attributeName);shortcodeAttributes.push([attributeName,'"'+attributeValue+'"'].join('='))}return'[kunta_api_service_component '+shortcodeAttributes.join(' ')+']'}return match})}},{key:'openElementEditor',value:function openElementEditor(element){var placeholderAttr=element.attributes['data-kunta-api-placeholder'];if(placeholderAttr){var serviceId=element.attributes['data-service-id'].value;this.editor.execCommand('kunta-api-service-edit','',{serviceId:serviceId})}}},{key:'findService',value:function findService(id,callback){$.post(ajaxurl,{'action':'kunta_api_load_service','serviceId':id},function(response){callback(null,JSON.parse(response))}).fail(function(response){callback(response.responseText||response.statusText)})}},{key:'onBeforeSetcontent',value:function onBeforeSetcontent(event){event.content=this.replaceShortcodes(event.content)}},{key:'onGetContent',value:function onGetContent(event){event.content=this.restoreShortcodes(event.content)}},{key:'onDblClick',value:function onDblClick(event){var element=event.target;this.openElementEditor(element)}},{key:'onServiceEdit',value:function onServiceEdit(ui,options){var _this3=this;this.findService(options.serviceId,function(err,service){if(err){tinyMCE.activeEditor.windowManager.alert(err)}else{var dialog=new ServiceDialog(_this3.editor,service);dialog.open()}})}}]);return ServiceEditor}();var ServiceEmbed=function(){function ServiceEmbed(editor){_classCallCheck(this,ServiceEmbed);this.editor=editor;this.displayLocale='fi';this.searching=false;this.pending=false;this.addButton()}_createClass(ServiceEmbed,[{key:'addButton',value:function addButton(){var _this4=this;this.editor.addButton('kunta_api_service_embed',{title:'Search Kunta API services',onclick:function onclick(){_this4.editor.windowManager.open({title:'Search Kunta API services',width:768,height:500,body:[{type:'textbox',name:'kunta-api-service-query',label:'Query',onKeyUp:function onKeyUp(e){if(!_this4.searching){_this4.searching=true;_this4.searchServices(e.target.value,function(response){_this4.searching=false;if(_this4.pending){_this4.searchServices(e.target.value,function(innerResponse){_this4.handleResponse(innerResponse)})}else{_this4.handleResponse(response)}})}else{_this4.pending=true}}},{type:'label',classes:'kunta-api-search-info',text:'Kirjoita hakusana yll\xE4 olevaan hakukentt\xE4\xE4n'},{type:'container',classes:'kunta-api-search-results',minHeight:400}],onsubmit:function onsubmit(e){var responseHtml='';var allEmbedsFromSameChannel=true;var componentsToEmbed=$('.service-component-embed-input:checked');componentsToEmbed.each(function(){var component=$(this).attr('data-component-type');var serviceId=$(this).attr('data-service-id');responseHtml+='[kunta_api_service_component service-id="'+serviceId+'" component="'+component+'"]'});_this4.editor.insertContent(responseHtml)}})}})}},{key:'searchServices',value:function searchServices(query,callback){$('.mce-kunta-api-search-results').empty();$('.mce-kunta-api-search-results').append($('<div>').addClass('mce-kunta-api-search-results-loader'));$('.mce-kunta-api-search-info').text('Ladataan...');$.post(ajaxurl,{'action':'kunta_api_search_services','data':query},function(response){$('.mce-kunta-api-search-results-loader').remove();callback(JSON.parse(response))})}},{key:'getLocalizedValueAndType',value:function getLocalizedValueAndType(values,locale,type){for(var i=0;i<values.length;i++){if(locale===values[i].language&&type===values[i].type){return values[i].value}}return null}},{key:'appendResult',value:function appendResult(result){var resultContainer=$('<div>').addClass('mce-kunta-api-search-result-row');var name=this.getLocalizedValueAndType(result.names,this.displayLocale,'Name');resultContainer.append($('<p>').addClass('mce-kunta-api-search-result-title').text(name));Object.keys(SUPPORTED_COMPONENTS).forEach(function(component){var options=SUPPORTED_COMPONENTS[component];resultContainer.append($('<p>').append($('<input>').addClass('service-component-embed-input').attr({'type':'checkbox','data-component-type':component,'data-service-id':result.id})).append($('<span>').text(options.title)))});$('.mce-kunta-api-search-results').append(resultContainer)}},{key:'handleResponse',value:function handleResponse(response){$('.mce-kunta-api-search-results').empty();if(response.length===0){$('.mce-kunta-api-search-info').text('Hakusanalla ei l\xF6ytynyt yht\xE4\xE4n palvelua')}else{$('.mce-kunta-api-search-info').text('Kirjoita hakusana yll\xE4 olevaan hakukentt\xE4\xE4n')}for(var i=0;i<response.length;i++){this.appendResult(response[i])}}}]);return ServiceEmbed}();tinymce.PluginManager.add('kunta_api_service_embed',function(editor,url){new ServiceEmbed(editor);new ServiceEditor(editor)})})(tinymce,jQuery);
//# sourceMappingURL=plugin.js.map
