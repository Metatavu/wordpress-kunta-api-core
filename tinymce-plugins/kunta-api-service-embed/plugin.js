function getElectronicServiceChannelAdditionalDetailsMetaform(){return {"title":"Lisätiedot","sections":[{"title":"Lisätiedot","fields":[{"title":"Alue, jolla palvelupaikka palvelee","name":"areaType","type":"radio","required":true,"options":[{"name":"WholeCountry","text":"Koko maa"},{"name":"WholeCountryExceptAlandIslands","text":"Koko maa paitsi ei Ahvenanmaa","checked":true},{"name":"AreaType","text":"Rajattu alue"}],"contexts":["FORM"],"editable":true},{"visible-if":{"field":"areaType","equals":"AreaType"},"name":"areas","type":"autocomplete-multiple","title":"Valitse yksi tai useampi alue","required":true}]}]};}function getElectronicServiceChannelMetaform(){return {"title":"Verkkoasiointikanava","sections":[{"fields":[{"name":"name","type":"text","title":"Nimi","required":false,"contexts":"FORM","placeholder":"Kirjoita verkkoasiointikanavan nimi."},{"name":"shortDescription","type":"memo","title":"Tiivistelmä","required":false,"contexts":"FORM","placeholder":"Kirjoita lyhyt tiivistelmä hakukoneita varten."},{"name":"description","type":"memo","title":"Kuvaus","required":false,"contexts":"FORM","placeholder":"Kirjoita selkeä ja ymmärrettävä kuvausteksti."}]},{"fields":[{"title":"Verkko-osoite","type":"text","name":"url","placeholder":"Kirjoita tarkka verkko-osoite, aloita osoite http:// tai https://."},{"title":"Verkkoasiointi vaatii sähköisen tunnistautumisen","name":"requiresAuthentication","type":"boolean"},{"title":"Verkkoasiointi vaatii sähköisen allekirjoituksen","name":"requiresSignature","type":"boolean"},{"visible-if":{"field":"requiresSignature","equals":true},"title":"Allekirjoitusten lukumäärä?","name":"signatureQuantity","type":"number"},{"name":"supportPhones","type":"table","title":"Käytön tuen puhelinnumerot","required":false,"contexts":"FORM","addRows":true,"columns":[{"title":"Maan suuntanumero","type":"text","name":"prefixNumber","placeholder":"esim. +358","column-width":150},{"title":"Numero","type":"text","name":"number","placeholder":"esim. 45123467"},{"title":"Voi soittaa ulkomailta","type":"enum","name":"isFinnishServiceNumber","values":[{"value":"true","text":"Ei"},{"value":"false","text":"Kyllä"}]},{"title":"Maksullisuus","type":"enum","name":"serviceChargeType","values":[{"value":"Charged","text":"Maksullinen"},{"value":"Free","text":"Maksuton"},{"value":"Other","text":"Muu"}]},{"title":"Hintatiedot sanallisesti","type":"text","name":"chargeDescription","placeholder":"esim. jonotusajalta peritään normaali puhelumaksu."},{"title":"Lisätieto","type":"text","name":"additionalInformation","placeholder":"esim. Vaihde"}]},{"name":"supportEmails","type":"table","title":"Käytön tuen sähköpostiosoitteet","required":false,"contexts":"FORM","addRows":true,"columns":[{"type":"text","name":"value","placeholder":"esim. osoite@organisaatio.fi"}]},{"name":"attachments","type":"table","title":"Liiteet ja lisätietolinkit","required":false,"contexts":"FORM","addRows":true,"columns":[{"title":"Nimi","type":"text","name":"name","placeholder":"Kirjoita nimi"},{"title":"Kuvaus","type":"text","name":"description","placeholder":"Kirjoita tarvittaessa kuvausteksti"},{"title":"Verkko-osoite","type":"text","name":"url","placeholder":"Kirjoita tarkka verkko-osoite, aloita osoite http:// tai https://"}]},{"name":"serviceHours","type":"html","title":"Palveluajat","required":false,"contexts":"FORM","html":"<table class=\"serviceHours\"><tbody></tbody></table>"},{"name":"add-service-hour","type":"html","html":"<a class=\"btn btn-sm btn-success add-service-hour\">Lisää palveluaika</a>"},{"name":"edit-additional-details","type":"html","html":"<p><a class=\"btn btn-sm btn-success edit-additional-details\">Muokkaa lisätietoja</a></p>"}]}]};}function getServiceChannelsMetaform(){return {"title":"Palvelukanavat","sections":[{"fields":[{"name":"channels","type":"table","title":"Liitetyt kanavat","addRows":true,"columns":[{"type":"autocomplete","name":"name","title":"Nimi","placeholder":"Kirjoita liitettävän kanavan nimi."},{"column-width":63,"type":"button","text":"Muokka","class":"btn-success","action":"edit-channel"},{"column-width":63,"type":"button","text":"Poista","class":"btn-warning","action":"delete-row"}]}]}]};}function getServiceAdditionalDetailsMetaform(){return {"title":"Lisätiedot","sections":[{"title":"Lisätiedot","fields":[{"name":"languages","type":"autocomplete-multiple","title":"Kielet, joilla palvelupaikassa palvellaan","required":true},{"title":"Alue, jolla palvelu palvelee","name":"areaType","type":"radio","required":true,"options":[{"name":"WholeCountry","text":"Koko maa"},{"name":"WholeCountryExceptAlandIslands","text":"Koko maa paitsi ei Ahvenanmaa","checked":true},{"name":"AreaType","text":"Rajattu alue"}],"contexts":["FORM"],"editable":true},{"visible-if":{"field":"areaType","equals":"AreaType"},"name":"areas","type":"autocomplete-multiple","title":"Valitse yksi tai useampi alue","required":true}]},{"title":"Toteutustavat ja tuottajat","fields":[{"title":"Palvelua tuotetaan itse","name":"serviceProducersSelfProduced","type":"boolean"},{"title":"Ostopalvelut","name":"serviceProducersPurchaseServices","type":"autocomplete-multiple"},{"title":"Muut","name":"serviceProducersOthers","type":"autocomplete-multiple"}]}]};}function getServiceMetaform(){return {"title":"Palvelu","sections":[{"fields":[{"title":"Palvelun tyyppi","type":"radio","name":"type","options":[{"name":"Service","text":"Palvelu"},{"name":"PermissionAndObligation","text":"Lupa tai muu velvoite"},{"name":"ProfessionalQualifications","text":"Ammattipätevyys"}]},{"title":"Rahoitustyyppi","type":"radio","name":"fundingType","options":[{"name":"PubliclyFunded","text":"Julkinen palvelu"},{"name":"MarketFunded","text":"Yksityinen palvelu"}]},{"name":"name","type":"text","title":"Nimi","required":true,"contexts":"FORM","placeholder":"Kirjoita palvelua kuvaava, asiakaslähtöinen nimi."},{"name":"alternateName","type":"text","title":"Vaihtoehtoinen nimi","required":false,"contexts":"FORM","placeholder":"Kirjoita palvelulle tarvittaessa muu nimi."},{"name":"shortDescription","type":"memo","title":"Tiivistelmä","required":true,"contexts":"FORM","placeholder":"Kirjoita lyhyt tiivistelmä hakukoneita varten."},{"name":"description","type":"memo","title":"Kuvaus","required":true,"contexts":"FORM","placeholder":"Kirjoita selkeä ja ymmärrettävä kuvausteksti."},{"name":"requirements","type":"memo","title":"Ehdot ja kriteerit","required":false,"contexts":"FORM","placeholder":"Kirjoita lyhyesti, jos palveluun liittyy ehtoja, edellytyksiä tai kriteerejä."},{"name":"userInstruction","type":"memo","title":"Toimintaohjeet","required":false,"contexts":"FORM","placeholder":"Kirjoita ohjeistus, miten asiakkaan on toimittava palvelun saamiseksi."},{"title":"Maksullisuus","type":"radio","name":"serviceChargeType","options":[{"name":"Charged","text":"Maksullinen"},{"name":"Free","text":"Maksuton"}]},{"title":"Maksullisuuden lisätieto","type":"text","name":"chargeTypeAdditionalInfo","required":false,"placeholder":"Kirjoita maksullisuuden tiedot"},{"title":"Palvelussa on käytössä palveluseteli.","type":"radio","name":"serviceVouchersInUse","options":[{"name":"false","text":"Ei"},{"name":"true","text":"Kyllä"}]},{"visible-if":{"field":"serviceVouchersInUse","equals":"true"},"name":"serviceVouchers","type":"table","title":"Käyntiosoite","required":false,"contexts":"FORM","addRows":true,"columns":[{"type":"text","name":"value","title":"Nimi","placeholder":"Kirjoita verkkosivun nimi"},{"type":"text","name":"url","title":"Verkko-osoite","placeholder":"Kirjoita tarkka verkko-osoite, aloita osoite http:// tai https://."},{"type":"text","name":"additionalInformation","title":"Lisätieto","placeholder":"Kirjoita lisätietoa palvelusetelistä."},{"column-width":63,"type":"button","text":"Poista","class":"btn-warning","action":"delete-row"}]},{"name":"legislation","type":"table","title":"Linkki lakitietoihin","required":false,"contexts":"FORM","addRows":true,"columns":[{"type":"text","name":"name","title":"Nimi","placeholder":"Kirjoita verkkoasiointikanavan nimi."},{"type":"text","name":"webPage","title":"Verkko-osoite","placeholder":"Kirjoita tarkka verkko-osoite, aloita osoite http:// tai https://."},{"column-width":63,"type":"button","text":"Poista","class":"btn-warning","action":"delete-row"}]}]},{"title":"Ammattipätevyyden, luvan tai muun velvoitteen lisätiedot","visible-if":{"field":"type","equals":"ProfessionalQualifications","or":[{"field":"type","equals":"PermissionAndObligation"}]},"fields":[{"name":"deadLineAdditionalInfo","type":"memo","title":"Määräaika","required":false,"contexts":"FORM","placeholder":"Kirjoita määräaikaan liittyvät tiedot."},{"name":"processingTimeAdditionalInfo","type":"memo","title":"Käsittelyaika","required":false,"contexts":"FORM","placeholder":"Kirjoita käsittelyaikaan liittyvät tiedot."},{"name":"validityTimeAdditionalInfo","type":"memo","title":"Voimassaoloaika","required":false,"contexts":"FORM","placeholder":"Kirjoita voimassaoloaikaan liittyvät tiedot."}]},{"title":"","fields":[{"name":"edit-additional-details","type":"html","html":"<p><a class=\"btn btn-sm btn-success edit-additional-details\">Muokkaa muita lisätietoja</a></p>"}]}]};}'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}(function($){'use strict';var ElectronicServiceChannelEditorDialog=function(_window$AbstractServi){_inherits(ElectronicServiceChannelEditorDialog,_window$AbstractServi);function ElectronicServiceChannelEditorDialog(editor,channel){_classCallCheck(this,ElectronicServiceChannelEditorDialog);var _this=_possibleConstructorReturn(this,(ElectronicServiceChannelEditorDialog.__proto__||Object.getPrototypeOf(ElectronicServiceChannelEditorDialog)).call(this,editor,channel,'kunta_api_save_electronic_service_channel'));_this.on('afterDialogOpen',_this.onAfterDialogOpen.bind(_this));return _this}_createClass(ElectronicServiceChannelEditorDialog,[{key:'serviceChannelToForm',value:function serviceChannelToForm(locale){return{name:this.getTypedLocalizedValue(this.serviceChannel.names,locale,'Name'),shortDescription:this.getTypedLocalizedValue(this.serviceChannel.descriptions,locale,'ShortDescription'),description:this.getTypedLocalizedValue(this.serviceChannel.descriptions,locale,'Description'),requiresAuthentication:this.serviceChannel.requiresAuthentication,requiresSignature:this.serviceChannel.requiresSignature,signatureQuantity:this.serviceChannel.signatureQuantity,supportPhones:this.getLocalizedPhoneNumbers(this.serviceChannel.supportPhones,locale),supportEmails:this.getLocalizedEmails(this.serviceChannel.supportEmails,locale),url:this.getLocalizedValue(this.serviceChannel.urls,locale),languages:this.serviceChannel.languages,attachments:(this.serviceChannel.attachments||[]).filter(function(attachment){return attachment.url&&attachment.language===locale}),webPages:this.getLocalizedWebPages(this.serviceChannel.webPages,locale),serviceHours:null,publishingStatus:this.serviceChannel.publishingStatus}}},{key:'getServiceChannelFormViewModel',value:function getServiceChannelFormViewModel(){return getElectronicServiceChannelMetaform()}},{key:'additionalDetailsToForm',value:function additionalDetailsToForm(serviceChannel){return{areaCodes:this.areasToForm(serviceChannel.areas),areaType:serviceChannel.areaType}}},{key:'serviceChannelFromForm',value:function serviceChannelFromForm(channel,formValues){var _this2=this;var result=JSON.parse(JSON.stringify(channel));result.names=[];result.descriptions=[];result.urls=[];result.attachments=[];result.requiresSignature=false;result.requiresAuthentication=false;result.supportPhones=[];result.supportEmails=[];result.urls=[];result.attachments=[];this.supportedLocales.forEach(function(locale){var localeValues=formValues[locale];result.signatureQuantity=localeValues.signatureQuantity||result.signatureQuantity;result.requiresSignature=_this2.getFormBooleanValue(localeValues.requiresSignature,result.requiresSignature);result.publishingStatus=localeValues.publishingStatus||result.publishingStatus;result.requiresAuthentication=_this2.getFormBooleanValue(localeValues.requiresAuthentication,result.requiresAuthentication);_this2.setTypedLocalizedValue(result,'names',localeValues,'name',locale,'Name');_this2.setTypedLocalizedValue(result,'descriptions',localeValues,'shortDescription',locale,'ShortDescription');_this2.setTypedLocalizedValue(result,'descriptions',localeValues,'description',locale,'Description');_this2.setLocalizedTableValues(result,'supportPhones',localeValues,'supportPhones',locale,function(supportPhone){return!!supportPhone.number},function(supportPhone){return Object.assign({},supportPhone,{language:locale,isFinnishServiceNumber:'true'===supportPhone.isFinnishServiceNumber,type:'Phone'})});_this2.setLocalizedTableValues(result,'supportEmails',localeValues,'supportEmails',locale,function(supportEmail){return!!supportEmail.value});_this2.setLocalizedValue(result,'urls',localeValues,'url',locale);_this2.setLocalizedTableValues(result,'attachments',localeValues,'attachments',locale,function(attachment){return!!attachment.url},function(attachment){return Object.assign(attachment,{language:locale,type:'Attachment'})})});return result}},{key:'additionalDetailsFromForm',value:function additionalDetailsFromForm(newFormValues){this.serviceChannel.areaType=newFormValues.areaType;this.serviceChannel.areas=this.areasFromForm(newFormValues.areaType,newFormValues.areas)}},{key:'openAdditionalDetailsEditDialog',value:function openAdditionalDetailsEditDialog(){var _this3=this;var viewModel=getElectronicServiceChannelAdditionalDetailsMetaform();var formValues=this.additionalDetailsToForm(this.serviceChannel);var dialog=this.openMetaformDialog(this.prepareViewModel(viewModel),formValues,function(newFormValues){_this3.additionalDetailsFromForm(newFormValues)});this.createAreasAutocomplete(dialog.find('*[data-name="areas"]'),formValues.areaCodes)}},{key:'onAfterDialogOpen',value:function onAfterDialogOpen(data){var dialog=data.dialog;$(dialog).on('click','.add-service-hour',this.onAddServiceHourClick.bind(this));$(dialog).on('click','.edit-service-hour',this.onEditServiceHourClick.bind(this));$(dialog).on('click','.remove-service-hour',this.onRemoveServiceHourClick.bind(this));$(dialog).on('click','.edit-additional-details',this.onEditAdditionalDetailsClick.bind(this));this.redrawServiceHours();this.linkInputs(dialog,['requiresAuthentication','requiresSignature','signatureQuantity'])}},{key:'onAddServiceHourClick',value:function onAddServiceHourClick(event){var _this4=this;this.openServiceHourEditDialog(null,function(createdServiceHour){_this4.serviceChannel.serviceHours.push(createdServiceHour);_this4.redrawServiceHours()})}},{key:'onEditServiceHourClick',value:function onEditServiceHourClick(event){var _this5=this;var row=$(event.target).closest('tr');var index=row.index();var serviceHour=this.serviceChannel.serviceHours[index];this.openServiceHourEditDialog(serviceHour,function(updatedServiceHour){_this5.serviceChannel.serviceHours.splice(index,1,updatedServiceHour);_this5.redrawServiceHours()})}},{key:'onRemoveServiceHourClick',value:function onRemoveServiceHourClick(event){var row=$(event.target).closest('tr');var index=row.index();this.serviceChannel.serviceHours.splice(index,1);this.redrawServiceHours()}},{key:'onEditAdditionalDetailsClick',value:function onEditAdditionalDetailsClick(){this.openAdditionalDetailsEditDialog(this.serviceChannel)}}]);return ElectronicServiceChannelEditorDialog}(window.AbstractServiceChannelEditorDialog);window.ElectronicServiceChannelEditorDialog=ElectronicServiceChannelEditorDialog})(jQuery);;(function($){'use strict';var ServiceChannelsDialog=function(_window$KuntaApiAbstr){_inherits(ServiceChannelsDialog,_window$KuntaApiAbstr);function ServiceChannelsDialog(editor,service){_classCallCheck(this,ServiceChannelsDialog);var _this6=_possibleConstructorReturn(this,(ServiceChannelsDialog.__proto__||Object.getPrototypeOf(ServiceChannelsDialog)).call(this,editor));_this6.service=service;_this6._channelDetails=[{tabId:'electronic-channels',property:'electronicServiceChannelIds',title:'Verkkoasiointikanavat',afterProcessRow:_this6.onAfterElectronicChannelTableProcessRow.bind(_this6),click:_this6.onElectronicChannelTableEditChannelButtonClick.bind(_this6),findMethod:_this6.findElectronicServiceChannel},{tabId:'webpage-channels',property:'webPageServiceChannelIds',title:'Verkkosivu',afterProcessRow:_this6.onAfterWebPageTableProcessRow.bind(_this6),click:_this6.onWebPageChannelTableEditChannelButtonClick.bind(_this6),findMethod:_this6.findWebPageChannelServiceChannel},{tabId:'printable-form-service-channels',property:'printableFormServiceChannelIds',title:'Tulostettava lomake',afterProcessRow:_this6.onAfterPrintableFormTableProcessRow.bind(_this6),click:_this6.onPrintableFormChannelTableEditChannelButtonClick.bind(_this6),findMethod:_this6.findPrintableFormChannelServiceChannel},{tabId:'phone-service-channels',property:'phoneServiceChannelIds',title:'Puhelinasiointi',afterProcessRow:_this6.onAfterPhoneServiceTableProcessRow.bind(_this6),click:_this6.onPhoneServiceChannelTableEditChannelButtonClick.bind(_this6),findMethod:_this6.findPhoneServiceChannel},{tabId:'service-location-service-channels',property:'serviceLocationServiceChannelIds',title:'Palvelupaikka',afterProcessRow:_this6.onAfterServiceLocationTableProcessRow.bind(_this6),click:_this6.onServiceLocationServiceChannelTableEditChannelButtonClick.bind(_this6),findMethod:_this6.findServiceLocationServiceChannel}];return _this6}_createClass(ServiceChannelsDialog,[{key:'open',value:function open(){var _this7=this;var viewModel=getServiceChannelsMetaform();var formValues={};this.dialog=this.openTabbedMetaformDialog(this._channelDetails.map(function(channelDetail){return{id:channelDetail.tabId,title:channelDetail.title}}),viewModel,formValues,function(){var newFormValues={};_this7._channelDetails.forEach(function(channelDetail){newFormValues[channelDetail.tabId]={};$(_this7.dialog).find('#'+channelDetail.tabId+' form.metaform').metaform('val',true).forEach(function(value){newFormValues[channelDetail.tabId][value.name]=value.value})});_this7.dialog.dialog('widget').addClass('loading');var updatedService=_this7.translateServiceFromForm(newFormValues);_this7.saveService(updatedService,function(err){_this7.service=updatedService;_this7.dialog.dialog('widget').removeClass('loading');if(err){_this7.showError('Virhe tallentaessa',err)}else{_this7.dialog.dialog('close')}})});this._channelDetails.forEach(function(channelDetail){var tabId=channelDetail.tabId;var channelsTable=_this7.dialog.find('#'+tabId+' .table-field[data-field-name="channels"]');channelsTable.tableField('option','afterProcessRow',channelDetail.afterProcessRow);channelsTable.tableField('removeAllRows');var channelPromises=(_this7.service[channelDetail.property]||[]).map(function(channelId){return channelDetail.findMethod.call(_this7,channelId)});channelsTable.on('click','td button[data-action="edit-channel"]',channelDetail.click);Promise.all(channelPromises).then(function(channels){channels.forEach(function(channel){var row=channelsTable.tableField('addRow',{id:channel.id,name:_this7.getLocalizedValue(channel.names,'fi')});row.find('*[data-column-name="name"] input').metaformAutocomplete('val',{value:channel.id,label:_this7.getLocalizedValue(channel.names,'fi')}).change()})})})}},{key:'close',value:function close(){this.dialog.remove()}},{key:'openElectronicServiceChannelEditor',value:function openElectronicServiceChannelEditor(channelId){var _this8=this;if(!channelId){return}this.close();this.findElectronicServiceChannel(channelId).then(function(serviceChannel){var ElectronicServiceChannelEditorDialog=window.ElectronicServiceChannelEditorDialog;var channelDialog=new ElectronicServiceChannelEditorDialog(_this8.editor,serviceChannel);channelDialog.open()}).catch(function(err){tinyMCE.activeEditor.windowManager.alert(err)})}},{key:'openServiceLocationServiceChannelEditor',value:function openServiceLocationServiceChannelEditor(channelId){var _this9=this;if(!channelId){return}this.close();this.findServiceLocationServiceChannel(channelId).then(function(serviceChannel){var ServiceLocationServiceChannelDialog=window.ServiceLocationServiceChannelDialog;var dialog=new ServiceLocationServiceChannelDialog(_this9.editor,serviceChannel);dialog.open()}).catch(function(err){tinyMCE.activeEditor.windowManager.alert(err)})}},{key:'createElectronicServiceChannelsAutocomplete',value:function createElectronicServiceChannelsAutocomplete(element,channelId){element.metaformAutocomplete('val',channelId)}},{key:'translateServiceFromForm',value:function translateServiceFromForm(){var _this10=this;var result=JSON.parse(JSON.stringify(this.service));this._channelDetails.forEach(function(channelDetail){var formValues={};_this10.dialog.find('#'+channelDetail.tabId+' .metaform').metaform('val',true).forEach(function(value){formValues[value.name]=value.value});var tableData=formValues.channels;var channelIds=(tableData?JSON.parse(tableData):[]).map(function(tableRow){return tableRow.name}).filter(function(channelId){return!!channelId});result[channelDetail.property]=channelIds});return result}},{key:'onAfterElectronicChannelTableProcessRow',value:function onAfterElectronicChannelTableProcessRow(row){this.createChannelAutocomplete(row,this.searchElectronicServiceChannels.bind(this))}},{key:'onAfterWebPageTableProcessRow',value:function onAfterWebPageTableProcessRow(row){this.createChannelAutocomplete(row,this.searchWebPageServiceChannels.bind(this))}},{key:'onAfterPrintableFormTableProcessRow',value:function onAfterPrintableFormTableProcessRow(row){this.createChannelAutocomplete(row,this.searchPrintableFormServiceChannels.bind(this))}},{key:'onAfterPhoneServiceTableProcessRow',value:function onAfterPhoneServiceTableProcessRow(row){this.createChannelAutocomplete(row,this.searchPhoneServiceChannels.bind(this))}},{key:'onAfterServiceLocationTableProcessRow',value:function onAfterServiceLocationTableProcessRow(row){this.createChannelAutocomplete(row,this.searchServiceLocationServiceChannels.bind(this))}},{key:'createChannelAutocomplete',value:function createChannelAutocomplete(row,searchCall){var _this11=this;row.find('*[data-column-name="name"] input').metaformAutocomplete('option','customSource',function(input,callback){searchCall(input.term+'*').then(function(channels){callback((channels||[]).map(function(channel){return{value:channel.id,label:_this11.getLocalizedValue(channel.names,'fi')}}))}).catch(function(err){tinyMCE.activeEditor.windowManager.alert(err)})})}},{key:'onElectronicChannelTableEditChannelButtonClick',value:function onElectronicChannelTableEditChannelButtonClick(event){event.preventDefault();var value=$(event.target).closest('tr').find('*[data-column-name="name"] input').metaformAutocomplete('val');this.openElectronicServiceChannelEditor(value.value)}},{key:'onWebPageChannelTableEditChannelButtonClick',value:function onWebPageChannelTableEditChannelButtonClick(event){event.preventDefault();var value=$(event.target).closest('tr').find('*[data-column-name="name"] input').metaformAutocomplete('val')}},{key:'onPrintableFormChannelTableEditChannelButtonClick',value:function onPrintableFormChannelTableEditChannelButtonClick(event){event.preventDefault();var value=$(event.target).closest('tr').find('*[data-column-name="name"] input').metaformAutocomplete('val')}},{key:'onPhoneServiceChannelTableEditChannelButtonClick',value:function onPhoneServiceChannelTableEditChannelButtonClick(event){event.preventDefault();var value=$(event.target).closest('tr').find('*[data-column-name="name"] input').metaformAutocomplete('val')}},{key:'onServiceLocationServiceChannelTableEditChannelButtonClick',value:function onServiceLocationServiceChannelTableEditChannelButtonClick(event){event.preventDefault();var value=$(event.target).closest('tr').find('*[data-column-name="name"] input').metaformAutocomplete('val');this.openServiceLocationServiceChannelEditor(value.value)}}]);return ServiceChannelsDialog}(window.KuntaApiAbstractEditDialog);window.ServiceChannelsDialog=ServiceChannelsDialog})(jQuery);;(function(tinymce,$){var SUPPORTED_COMPONENTS={'description':{'title':'Palvelun kuvaus'},'userInstruction':{'title':'Palvelun toimintaohjeet'},'languages':{'title':'Palvelun kielet'},'electronicServiceChannelIds':{'title':'Palvelun s\xE4hk\xF6iset palvelukanavat'},'phoneServiceChannelIds':{'title':'Palvelun puhelinpalvelukanavat'},'printableFormServiceChannelIds':{'title':'Palveluun liittyv\xE4t lomakkeet'},'serviceLocationServiceChannelIds':{'title':'Palvelun toimipisteet'},'webPageServiceChannelIds':{'title':'Palvelun hy\xF6dylliset linkit'}};var ServiceDialog=function(_window$KuntaApiAbstr2){_inherits(ServiceDialog,_window$KuntaApiAbstr2);function ServiceDialog(editor,service){_classCallCheck(this,ServiceDialog);var _this12=_possibleConstructorReturn(this,(ServiceDialog.__proto__||Object.getPrototypeOf(ServiceDialog)).call(this,editor));_this12.service=service;return _this12}_createClass(ServiceDialog,[{key:'open',value:function open(){var _this13=this;var viewModel=getServiceMetaform();var formValues={};this.supportedLocales.map(function(locale){formValues[locale]=_this13.serviceToForm(locale)});var dialog=this.openLocalizedMetaformDialog(viewModel,formValues,function(newFormValues){dialog.dialog('widget').addClass('loading');var updatedService=_this13.translateServiceFromForm(newFormValues);var validationError=_this13.validate(updatedService);if(validationError!==null){_this13.showError('Virheellinen sy\xF6te',validationError)}else{_this13.service=updatedService;_this13.saveService(_this13.service,function(err){dialog.dialog('widget').removeClass('loading');if(err){_this13.showError('Virhe tallentaessa',err)}else{dialog.dialog('close')}})}});$(dialog).on('click','.edit-additional-details',this.onEditAdditionalDetailsClick.bind(this))}},{key:'openAdditionalDetailsEditDialog',value:function openAdditionalDetailsEditDialog(){var _this14=this;var viewModel=getServiceAdditionalDetailsMetaform();this.additionalDetailsToForm().then(function(formValues){var dialog=_this14.openMetaformDialog(_this14.prepareViewModel(viewModel),formValues,function(newFormValues){_this14.additionalDetailsFromForm(newFormValues)});_this14.createLanguagesAutocomplete(dialog.find('*[data-name="languages"]'),formValues.languageCodes);_this14.createAreasAutocomplete(dialog.find('*[data-name="areas"]'),formValues.areaCodes);_this14.createServiceProducersAutocomplete(dialog.find('*[data-name="serviceProducersPurchaseServices"]'),formValues.serviceProducersPurchaseServiceItems);_this14.createServiceProducersAutocomplete(dialog.find('*[data-name="serviceProducersOthers"]'),formValues.serviceProducersOtherItems)})}},{key:'validate',value:function validate(service){return null}},{key:'serviceToForm',value:function serviceToForm(locale){var _this15=this;var type=this.service.type;var chargeType=this.service.chargeType;var fundingType=this.service.fundingType;var name=this.getTypedLocalizedValue(this.service.names,locale,'Name');var alternateName=this.getTypedLocalizedValue(this.service.names,locale,'AlternateName');var shortDescription=this.getTypedLocalizedValue(this.service.descriptions,locale,'ShortDescription');var description=this.getTypedLocalizedValue(this.service.descriptions,locale,'Description');var chargeTypeAdditionalInfo=this.getTypedLocalizedValue(this.service.descriptions,locale,'ChargeTypeAdditionalInfo');var userInstruction=this.getTypedLocalizedValue(this.service.descriptions,locale,'ServiceUserInstruction');var deadLineAdditionalInfo=this.getTypedLocalizedValue(this.service.descriptions,locale,'DeadLineAdditionalInfo');var processingTimeAdditionalInfo=this.getTypedLocalizedValue(this.service.descriptions,locale,'ProcessingTimeAdditionalInfo');var validityTimeAdditionalInfo=this.getTypedLocalizedValue(this.service.descriptions,locale,'ValidityTimeAdditionalInfo');var requirements=this.getLocalizedValue(this.service.requirements,locale);var vouchers=this.service.vouchers.filter(function(voucher){return voucher.value&&voucher.language===locale});var legislation=this.service.legislation.map(function(legistation){return{name:_this15.getLocalizedValue(legistation.names,locale),webPage:_this15.getLocalizedValue(legistation.webPages,locale,'url')}}).filter(function(legistation){return legistation.name&&legistation.webPage});return{type:type,serviceChargeType:chargeType,fundingType:fundingType,name:name,alternateName:alternateName,shortDescription:shortDescription,description:description,chargeTypeAdditionalInfo:chargeTypeAdditionalInfo,userInstruction:userInstruction,deadLineAdditionalInfo:deadLineAdditionalInfo,processingTimeAdditionalInfo:processingTimeAdditionalInfo,validityTimeAdditionalInfo:validityTimeAdditionalInfo,requirements:requirements,serviceVouchersInUse:vouchers.length>0?'true':'false',serviceVouchers:vouchers,legislation:legislation}}},{key:'createServiceProducersAutocomplete',value:function createServiceProducersAutocomplete(element,organizationItems){var _this16=this;element.metaformMultivalueAutocomplete('val',organizationItems).metaformMultivalueAutocomplete('option','customSource',function(input,callback){var search=_this16.splitSearchTerms(input.term);if(!search){callback([]);return}_this16.searchOrganizations(search).then(function(organizations){callback(organizations.map(function(organization){return{value:organization.id,label:_this16.getLocalizedValue(organization.names,'fi')}}))}).catch(function(err){tinyMCE.activeEditor.windowManager.alert(err)})})}},{key:'serviceProducersToForm',value:function serviceProducersToForm(serviceOrganizations,provisionType){var _this17=this;var findPromises=(serviceOrganizations||[]).filter(function(serviceOrganization){return serviceOrganization.roleType==='Producer'&&serviceOrganization.provisionType===provisionType}).map(function(serviceOrganization){return _this17.findOrganization(serviceOrganization.organizationId)});return Promise.all(findPromises).then(function(organizations){return organizations.map(function(organization){return{value:organization.id,label:_this17.getLocalizedValue(organization.names,'fi')}})}).catch(function(err){tinyMCE.activeEditor.windowManager.alert(err)})}},{key:'additionalDetailsToForm',value:function additionalDetailsToForm(){var _this18=this;var formPromises=[this.languagesToForm(this.service.languages),this.serviceProducersToForm(this.service.organizations,'PurchaseServices'),this.serviceProducersToForm(this.service.organizations,'Other')];return Promise.all(formPromises).then(function(results){var languageCodes=results[0];var serviceProducersPurchaseServices=results[1];var serviceProducersOthers=results[2];return{languageCodes:languageCodes,areaCodes:_this18.areasToForm(_this18.service.areas),areaType:_this18.service.areaType,serviceProducersPurchaseServiceItems:serviceProducersPurchaseServices,serviceProducersOtherItems:serviceProducersOthers,serviceProducersSelfProduced:(_this18.service.organizations||[]).filter(function(serviceOrganization){return serviceOrganization.roleType==='Producer'&&serviceOrganization.provisionType==='SelfProduced'}).length>0}})}},{key:'translateServiceFromForm',value:function translateServiceFromForm(formValues){var _this19=this;var result=JSON.parse(JSON.stringify(this.service));result.names=[];result.descriptions=[];result.vouchers=[];this.supportedLocales.forEach(function(locale){var localeValues=formValues[locale];result.type=localeValues.type||result.type;result.chargeType=localeValues.serviceChargeType||result.chargeType;result.fundingType=localeValues.fundingType||result.fundingType;_this19.setTypedLocalizedValue(result,'names',localeValues,'name',locale,'Name');_this19.setTypedLocalizedValue(result,'names',localeValues,'alternateName',locale,'AlternateName');_this19.setTypedLocalizedValue(result,'descriptions',localeValues,'shortDescription',locale,'ShortDescription');_this19.setTypedLocalizedValue(result,'descriptions',localeValues,'description',locale,'Description');_this19.setTypedLocalizedValue(result,'descriptions',localeValues,'chargeTypeAdditionalInfo',locale,'ChargeTypeAdditionalInfo');_this19.setTypedLocalizedValue(result,'descriptions',localeValues,'userInstruction',locale,'ServiceUserInstruction');_this19.setTypedLocalizedValue(result,'descriptions',localeValues,'deadLineAdditionalInfo',locale,'DeadLineAdditionalInfo');_this19.setTypedLocalizedValue(result,'descriptions',localeValues,'processingTimeAdditionalInfo',locale,'ProcessingTimeAdditionalInfo');_this19.setTypedLocalizedValue(result,'descriptions',localeValues,'validityTimeAdditionalInfo',locale,'ValidityTimeAdditionalInfo');_this19.setLocalizedValue(result,'requirements',localeValues,'requirements',locale);_this19.setLocalizedTableValues(result,'vouchers',localeValues,'serviceVouchers',locale,function(voucher){return voucher.value&&voucher.url})});return result}},{key:'additionalDetailsFromForm',value:function additionalDetailsFromForm(newFormValues){var _this20=this;this.service.areaType=newFormValues.areaType;this.service.languages=(newFormValues.languages||'').split(',');this.service.areas=this.areasFromForm(newFormValues.areaType,newFormValues.areas);this.service.organizations=this.service.organizations.filter(function(serviceOrganization){return serviceOrganization.roleType!=='Producer'});var responsibleOrganizations=this.service.organizations.filter(function(serviceOrganization){return serviceOrganization.roleType==='Responsible'});var formProducersPurchaseServices=(newFormValues.serviceProducersPurchaseServices||'').split(',');var formProducersOthers=(newFormValues.serviceProducersOthers||'').split(',');var serviceProducersPurchaseServices=formProducersPurchaseServices.forEach(function(organizationId){_this20.service.organizations.push({provisionType:'PurchaseServices',roleType:'Producer',organizationId:organizationId})});var serviceProducersPurchaseOthers=formProducersOthers.forEach(function(organizationId){_this20.service.organizations.push({provisionType:'Other',roleType:'Producer',organizationId:organizationId})});if(newFormValues.serviceProducersSelfProduced){this.service.organizations.push({provisionType:'SelfProduced',roleType:'Producer',organizationId:responsibleOrganizations.length>0?responsibleOrganizations[0].organizationId:null})}}},{key:'onEditAdditionalDetailsClick',value:function onEditAdditionalDetailsClick(){this.openAdditionalDetailsEditDialog()}}]);return ServiceDialog}(window.KuntaApiAbstractEditDialog);var ServiceEditor=function(){function ServiceEditor(editor){_classCallCheck(this,ServiceEditor);this.buttonStyle={'color':'#555','width':'100%','border':'1px solid #ccc','background':'#f7f7f7','display':'block','padding':'5px','margin-top':'5px','margin-bottom':'5px','cursor':'pointer'};this.editor=editor;this.editor.on('BeforeSetcontent',this.onBeforeSetcontent.bind(this));this.editor.on('GetContent',this.onGetContent.bind(this));this.editor.on('DblClick',this.onDblClick.bind(this));this.editor.addCommand('kunta-api-service-edit',this.onServiceEdit.bind(this))}_createClass(ServiceEditor,[{key:'parseAttributes',value:function parseAttributes(string){var result=[];var re=/([a-zA-Z-_]*)(\=\")([a-zA-Z0-9-]*)(\")/g;var match=null;do{match=re.exec(string);if(match&&match.length>3){result.push({name:match[1],value:match[3]})}}while(match);return result}},{key:'getComponentTitle',value:function getComponentTitle(name){return SUPPORTED_COMPONENTS[name].title}},{key:'replaceShortcodes',value:function replaceShortcodes(content){var _this21=this;return content.replace(/(\[kunta_api_service_component)([a-zA-Z0-9 -=]*)(\])/g,function(all,tag,attributesText,end){var attributes=_this21.parseAttributes(attributesText);var placeholder=$('<input>').attr({'type':'button','data-kunta-api-placeholder':'service'}).css(_this21.buttonStyle);for(var i=0;i<attributes.length;i++){var attribute=attributes[i];placeholder.attr('data-'+attribute.name,attribute.value)}var component=placeholder.attr('data-component');if(!SUPPORTED_COMPONENTS[component]){return all}placeholder.attr('value',_this21.getComponentTitle(component));return $('<div>').append(placeholder).html()})}},{key:'restoreShortcodes',value:function restoreShortcodes(content){return content.replace(/<input [^>]+>/g,function(match){var input=$(match);if(input.attr('data-kunta-api-placeholder')==='service'){var shortcodeAttributes=[];var attributeNames=['service-id','component'];for(var i=0;i<attributeNames.length;i++){var attributeName=attributeNames[i];var attributeValue=input.attr('data-'+attributeName);shortcodeAttributes.push([attributeName,'"'+attributeValue+'"'].join('='))}return'[kunta_api_service_component '+shortcodeAttributes.join(' ')+']'}return match})}},{key:'openElementEditor',value:function openElementEditor(element){var placeholderAttr=element.attributes['data-kunta-api-placeholder'];if(placeholderAttr&&placeholderAttr.value==='service'){var serviceId=element.attributes['data-service-id'].value;var component=element.attributes['data-component'].value;this.editor.execCommand('kunta-api-service-edit','',{serviceId:serviceId,component:component})}}},{key:'findService',value:function findService(id,callback){$.post(ajaxurl,{'action':'kunta_api_load_service','serviceId':id},function(response){callback(null,JSON.parse(response))}).fail(function(response){callback(response.responseText||response.statusText)})}},{key:'onBeforeSetcontent',value:function onBeforeSetcontent(event){event.content=this.replaceShortcodes(event.content)}},{key:'onGetContent',value:function onGetContent(event){event.content=this.restoreShortcodes(event.content)}},{key:'onDblClick',value:function onDblClick(event){var element=event.target;this.openElementEditor(element)}},{key:'onServiceEdit',value:function onServiceEdit(ui,options){var _this22=this;this.findService(options.serviceId,function(err,service){if(err){tinyMCE.activeEditor.windowManager.alert(err)}else{var channelComponents=['electronicServiceChannelIds'];var dialog=channelComponents.indexOf(options.component)===-1?new ServiceDialog(_this22.editor,service):new ServiceChannelsDialog(_this22.editor,service);dialog.open()}})}}]);return ServiceEditor}();var ServiceEmbed=function(){function ServiceEmbed(editor){_classCallCheck(this,ServiceEmbed);this.editor=editor;this.displayLocale='fi';this.searching=false;this.pending=false;this.addButton()}_createClass(ServiceEmbed,[{key:'addButton',value:function addButton(){var _this23=this;this.editor.addButton('kunta_api_service_embed',{title:'Search Kunta API services',onclick:function onclick(){_this23.editor.windowManager.open({title:'Search Kunta API services',width:768,height:500,body:[{type:'textbox',name:'kunta-api-service-query',label:'Query',onKeyUp:function onKeyUp(e){if(!_this23.searching){_this23.searching=true;_this23.searchServices(e.target.value,function(response){_this23.searching=false;if(_this23.pending){_this23.searchServices(e.target.value,function(innerResponse){_this23.handleResponse(innerResponse)})}else{_this23.handleResponse(response)}})}else{_this23.pending=true}}},{type:'label',classes:'kunta-api-search-info',text:'Kirjoita hakusana yll\xE4 olevaan hakukentt\xE4\xE4n'},{type:'container',classes:'kunta-api-search-results',minHeight:400}],onsubmit:function onsubmit(e){var responseHtml='';var allEmbedsFromSameChannel=true;var componentsToEmbed=$('.service-component-embed-input:checked');componentsToEmbed.each(function(){var component=$(this).attr('data-component-type');var serviceId=$(this).attr('data-service-id');responseHtml+='[kunta_api_service_component service-id="'+serviceId+'" component="'+component+'"]'});_this23.editor.insertContent(responseHtml)}})}})}},{key:'searchServices',value:function searchServices(query,callback){$('.mce-kunta-api-search-results').empty();$('.mce-kunta-api-search-results').append($('<div>').addClass('mce-kunta-api-search-results-loader'));$('.mce-kunta-api-search-info').text('Ladataan...');$.post(ajaxurl,{'action':'kunta_api_search_services','data':query},function(response){$('.mce-kunta-api-search-results-loader').remove();callback(JSON.parse(response))})}},{key:'getLocalizedValueAndType',value:function getLocalizedValueAndType(values,locale,type){for(var i=0;i<values.length;i++){if(locale===values[i].language&&type===values[i].type){return values[i].value}}return null}},{key:'appendResult',value:function appendResult(result){var resultContainer=$('<div>').addClass('mce-kunta-api-search-result-row');var name=this.getLocalizedValueAndType(result.names,this.displayLocale,'Name');resultContainer.append($('<p>').addClass('mce-kunta-api-search-result-title').text(name));Object.keys(SUPPORTED_COMPONENTS).forEach(function(component){var options=SUPPORTED_COMPONENTS[component];resultContainer.append($('<p>').append($('<input>').addClass('service-component-embed-input').attr({'type':'checkbox','data-component-type':component,'data-service-id':result.id})).append($('<span>').text(options.title)))});$('.mce-kunta-api-search-results').append(resultContainer)}},{key:'handleResponse',value:function handleResponse(response){$('.mce-kunta-api-search-results').empty();if(response.length===0){$('.mce-kunta-api-search-info').text('Hakusanalla ei l\xF6ytynyt yht\xE4\xE4n palvelua')}else{$('.mce-kunta-api-search-info').text('Kirjoita hakusana yll\xE4 olevaan hakukentt\xE4\xE4n')}for(var i=0;i<response.length;i++){this.appendResult(response[i])}}}]);return ServiceEmbed}();tinymce.PluginManager.add('kunta_api_service_embed',function(editor,url){new ServiceEmbed(editor);new ServiceEditor(editor)})})(tinymce,jQuery);
//# sourceMappingURL=plugin.js.map
