function getServiceMetaform(){return {"title":"Palvelu","sections":[{"fields":[{"title":"Palvelun tyyppi","type":"radio","name":"type","options":[{"name":"Service","text":"Palvelu"},{"name":"PermissionAndObligation","text":"Lupa tai muu velvoite"},{"name":"ProfessionalQualifications","text":"Ammattipätevyys"}]},{"title":"Rahoitustyyppi","type":"radio","name":"fundingType","options":[{"name":"PubliclyFunded","text":"Julkinen palvelu"},{"name":"MarketFunded","text":"Yksityinen palvelu"}]},{"name":"name","type":"text","title":"Nimi","required":true,"contexts":"FORM","placeholder":"Kirjoita palvelua kuvaava, asiakaslähtöinen nimi."},{"name":"alternateName","type":"text","title":"Vaihtoehtoinen nimi","required":false,"contexts":"FORM","placeholder":"Kirjoita palvelulle tarvittaessa muu nimi."},{"name":"shortDescription","type":"memo","title":"Tiivistelmä","required":true,"contexts":"FORM","placeholder":"Kirjoita lyhyt tiivistelmä hakukoneita varten."},{"name":"description","type":"memo","title":"Kuvaus","required":true,"contexts":"FORM","placeholder":"Kirjoita selkeä ja ymmärrettävä kuvausteksti."},{"name":"requirements","type":"memo","title":"Ehdot ja kriteerit","required":false,"contexts":"FORM","placeholder":"Kirjoita lyhyesti, jos palveluun liittyy ehtoja, edellytyksiä tai kriteerejä."},{"name":"userInstruction","type":"memo","title":"Toimintaohjeet","required":false,"contexts":"FORM","placeholder":"Kirjoita ohjeistus, miten asiakkaan on toimittava palvelun saamiseksi."},{"title":"Maksullisuus","type":"radio","name":"serviceChargeType","options":[{"name":"Charged","text":"Maksullinen"},{"name":"Free","text":"Maksuton"}]},{"title":"Maksullisuuden lisätieto","type":"text","name":"chargeTypeAdditionalInfo","required":false,"placeholder":"Kirjoita maksullisuuden tiedot"},{"title":"Palvelussa on käytössä palveluseteli.","type":"radio","name":"serviceVouchersInUse","options":[{"name":"false","text":"Ei"},{"name":"true","text":"Kyllä"}]},{"visible-if":{"field":"serviceVouchersInUse","equals":"true"},"name":"serviceVouchers","type":"table","title":"Käyntiosoite","required":false,"contexts":"FORM","addRows":true,"columns":[{"type":"text","name":"value","title":"Nimi","placeholder":"Kirjoita verkkosivun nimi"},{"type":"text","name":"url","title":"Verkko-osoite","placeholder":"Kirjoita tarkka verkko-osoite, aloita osoite http:// tai https://."},{"type":"text","name":"additionalInformation","title":"Lisätieto","placeholder":"Kirjoita lisätietoa palvelusetelistä."},{"column-width":63,"type":"button","text":"Poista","class":"btn-warning","action":"delete-row"}]},{"name":"legislation","type":"table","title":"Linkki lakitietoihin","required":false,"contexts":"FORM","addRows":true,"columns":[{"type":"text","name":"name","title":"Nimi","placeholder":"Kirjoita verkkoasiointikanavan nimi."},{"type":"text","name":"webPage","title":"Verkko-osoite","placeholder":"Kirjoita tarkka verkko-osoite, aloita osoite http:// tai https://."},{"column-width":63,"type":"button","text":"Poista","class":"btn-warning","action":"delete-row"}]}]},{"title":"Ammattipätevyyden, luvan tai muun velvoitteen lisätiedot","visible-if":{"field":"type","equals":"ProfessionalQualifications","or":[{"field":"type","equals":"PermissionAndObligation"}]},"fields":[{"name":"deadLineAdditionalInfo","type":"memo","title":"Määräaika","required":false,"contexts":"FORM","placeholder":"Kirjoita määräaikaan liittyvät tiedot."},{"name":"processingTimeAdditionalInfo","type":"memo","title":"Käsittelyaika","required":false,"contexts":"FORM","placeholder":"Kirjoita käsittelyaikaan liittyvät tiedot."},{"name":"validityTimeAdditionalInfo","type":"memo","title":"Voimassaoloaika","required":false,"contexts":"FORM","placeholder":"Kirjoita voimassaoloaikaan liittyvät tiedot."}]},{"title":"","fields":[{"name":"edit-additional-details","type":"html","html":"<p><a class=\"btn btn-sm btn-success edit-additional-details\">Muokkaa muita lisätietoja</a></p>"}]}]};}'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called')}return call&&(typeof call==='object'||typeof call==='function')?call:self}function _inherits(subClass,superClass){if(typeof superClass!=='function'&&superClass!==null){throw new TypeError('Super expression must either be null or a function, not '+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}/* jshint esversion: 6 *//* global ajaxurl, tinymce, moment, Promise */(function(tinymce,$){// TODO: Service:
// Palvelun pohjakuvaus
// Luokittelu ja asiasanat
// Toteutustapa ja tuottaja
// Tyypit:
//   - Palvelu
//   - Lupa tai muu velvoite
// Lisätiedot:
//   - Kielet, joilla palvelu on saatavilla
//   - Alue, jolla palvelu on käytettävissä
var SUPPORTED_COMPONENTS={'description':{'title':'Palvelun kuvaus'},'userInstruction':{'title':'Palvelun toimintaohjeet'},'languages':{'title':'Palvelun kielet'},'electronicServiceChannelIds':{'title':'Palvelun s\xE4hk\xF6iset palvelukanavat'},'phoneServiceChannelIds':{'title':'Palvelun puhelinpalvelukanavat'},'printableFormServiceChannelIds':{'title':'Palveluun liittyv\xE4t lomakkeet'},'serviceLocationServiceChannelIds':{'title':'Palvelun toimipisteet'},'webPageServiceChannelIds':{'title':'Palvelun hy\xF6dylliset linkit'}};var ServiceDialog=function(_window$KuntaApiAbstr){_inherits(ServiceDialog,_window$KuntaApiAbstr);/**
     * Constructs edit dialog
     * 
     * @param {type} editor TinyMCE editor instance
     * @param {type} service
     */function ServiceDialog(editor,service){_classCallCheck(this,ServiceDialog);var _this=_possibleConstructorReturn(this,(ServiceDialog.__proto__||Object.getPrototypeOf(ServiceDialog)).call(this,editor));_this.service=service;return _this}_createClass(ServiceDialog,[{key:'saveService',value:function saveService(service,callback){$.post(ajaxurl,{'action':'kunta_api_save_service','service':JSON.stringify(this.service)},function(response){callback()}).fail(function(response){callback(response.responseText||response.statusText||'Unknown error occurred')})}},{key:'open',value:function open(){var _this2=this;var viewModel=getServiceMetaform();var formValues={};this.supportedLocales.map(function(locale){formValues[locale]=_this2.serviceToForm(locale)});var dialog=this.openLocalizedMetaformDialog(viewModel,formValues,function(newFormValues){dialog.dialog('widget').addClass('loading');var updatedService=_this2.translateServiceFromForm(newFormValues);var validationError=_this2.validate(updatedService);if(validationError!==null){_this2.showError('Virheellinen sy\xF6te',validationError)}else{_this2.service=updatedService;_this2.saveService(_this2.service,function(err){dialog.dialog('widget').removeClass('loading');if(err){_this2.showError('Virhe tallentaessa',err)}else{dialog.dialog('close')}})}});/**
      $(dialog).on('click', '.add-service-hour', this._onAddServiceHourClick.bind(this));
      $(dialog).on('click', '.edit-service-hour', this._onEditServiceHourClick.bind(this));
      $(dialog).on('click', '.remove-service-hour', this._onRemoveServiceHourClick.bind(this));
      **/$(dialog).on('click','.edit-additional-details',this.onEditAdditionalDetailsClick.bind(this))}},{key:'openAdditionalDetailsEditDialog',value:function openAdditionalDetailsEditDialog(){var _this3=this;var viewModel=getServiceAdditionalDetailsMetaform();this.additionalDetailsToForm().then(function(formValues){var dialog=_this3.openMetaformDialog(_this3.prepareViewModel(viewModel),formValues,function(newFormValues){_this3.additionalDetailsFromForm(newFormValues)});_this3.createLanguagesAutocomplete(dialog.find('*[data-name="languages"]'),formValues.languageCodes);_this3.createAreasAutocomplete(dialog.find('*[data-name="areas"]'),formValues.areaCodes)})}},{key:'validate',value:function validate(service){return null}},{key:'serviceToForm',value:function serviceToForm(locale){var _this4=this;var type=this.service.type;var chargeType=this.service.chargeType;var fundingType=this.service.fundingType;var name=this.getTypedLocalizedValue(this.service.names,locale,'Name');var alternateName=this.getTypedLocalizedValue(this.service.names,locale,'AlternateName');var shortDescription=this.getTypedLocalizedValue(this.service.descriptions,locale,'ShortDescription');var description=this.getTypedLocalizedValue(this.service.descriptions,locale,'Description');var chargeTypeAdditionalInfo=this.getTypedLocalizedValue(this.service.descriptions,locale,'ChargeTypeAdditionalInfo');var userInstruction=this.getTypedLocalizedValue(this.service.descriptions,locale,'ServiceUserInstruction');var deadLineAdditionalInfo=this.getTypedLocalizedValue(this.service.descriptions,locale,'DeadLineAdditionalInfo');var processingTimeAdditionalInfo=this.getTypedLocalizedValue(this.service.descriptions,locale,'ProcessingTimeAdditionalInfo');var validityTimeAdditionalInfo=this.getTypedLocalizedValue(this.service.descriptions,locale,'ValidityTimeAdditionalInfo');var requirements=this.getLocalizedValue(this.service.requirements,locale);var vouchers=this.service.vouchers.filter(function(voucher){return voucher.value&&voucher.language===locale});var legislation=this.service.legislation.map(function(legistation){return{name:_this4.getLocalizedValue(legistation.names,locale),webPage:_this4.getLocalizedValue(legistation.webPages,locale,'url')}}).filter(function(legistation){return legistation.name&&legistation.webPage});return{type:type,serviceChargeType:chargeType,fundingType:fundingType,name:name,alternateName:alternateName,shortDescription:shortDescription,description:description,chargeTypeAdditionalInfo:chargeTypeAdditionalInfo,userInstruction:userInstruction,deadLineAdditionalInfo:deadLineAdditionalInfo,processingTimeAdditionalInfo:processingTimeAdditionalInfo,validityTimeAdditionalInfo:validityTimeAdditionalInfo,requirements:requirements,serviceVouchersInUse:vouchers.length>0?'true':'false',serviceVouchers:vouchers,legislation:legislation}}},{key:'additionalDetailsToForm',value:function additionalDetailsToForm(){var _this5=this;return this.languagesToForm(this.service.languages).then(function(languageCodes){return{languageCodes:languageCodes,areaCodes:_this5.areasToForm(_this5.service.areas),areaType:_this5.service.areaType}})}},{key:'translateServiceFromForm',value:function translateServiceFromForm(formValues){var _this6=this;var result=JSON.parse(JSON.stringify(this.service));result.names=[];result.descriptions=[];result.vouchers=[];this.supportedLocales.forEach(function(locale){var localeValues=formValues[locale];result.type=localeValues.type||result.type;result.chargeType=localeValues.serviceChargeType||result.chargeType;result.fundingType=localeValues.fundingType||result.fundingType;_this6.setTypedLocalizedValue(result,'names',localeValues,'name',locale,'Name');_this6.setTypedLocalizedValue(result,'names',localeValues,'alternateName',locale,'AlternateName');_this6.setTypedLocalizedValue(result,'descriptions',localeValues,'shortDescription',locale,'ShortDescription');_this6.setTypedLocalizedValue(result,'descriptions',localeValues,'description',locale,'Description');_this6.setTypedLocalizedValue(result,'descriptions',localeValues,'chargeTypeAdditionalInfo',locale,'ChargeTypeAdditionalInfo');_this6.setTypedLocalizedValue(result,'descriptions',localeValues,'userInstruction',locale,'ServiceUserInstruction');_this6.setTypedLocalizedValue(result,'descriptions',localeValues,'deadLineAdditionalInfo',locale,'DeadLineAdditionalInfo');_this6.setTypedLocalizedValue(result,'descriptions',localeValues,'processingTimeAdditionalInfo',locale,'ProcessingTimeAdditionalInfo');_this6.setTypedLocalizedValue(result,'descriptions',localeValues,'validityTimeAdditionalInfo',locale,'ValidityTimeAdditionalInfo');_this6.setLocalizedValue(result,'requirements',localeValues,'requirements',locale);_this6.setLocalizedTableValues(result,'vouchers',localeValues,'serviceVouchers',locale,function(voucher){return voucher.value&&voucher.url})});return result}},{key:'additionalDetailsFromForm',value:function additionalDetailsFromForm(newFormValues){console.log('this.service BEFORE',this.service);console.log('newFormValues',newFormValues);this.service.areaType=newFormValues.areaType;this.service.languages=(newFormValues.languages||'').split(',');this.service.areas=this.areasFromForm(newFormValues.areaType,newFormValues.areas);console.log('this.service.',this.service)}},{key:'onEditAdditionalDetailsClick',value:function onEditAdditionalDetailsClick(){this.openAdditionalDetailsEditDialog()}}]);return ServiceDialog}(window.KuntaApiAbstractEditDialog);var ServiceEditor=function(){function ServiceEditor(editor){_classCallCheck(this,ServiceEditor);this.buttonStyle={'color':'#555','width':'100%','border':'1px solid #ccc','background':'#f7f7f7','display':'block','padding':'5px','margin-top':'5px','margin-bottom':'5px','cursor':'pointer'};this.editor=editor;this.editor.on('BeforeSetcontent',this.onBeforeSetcontent.bind(this));this.editor.on('GetContent',this.onGetContent.bind(this));this.editor.on('DblClick',this.onDblClick.bind(this));this.editor.addCommand('kunta-api-service-edit',this.onServiceEdit.bind(this))}_createClass(ServiceEditor,[{key:'parseAttributes',value:function parseAttributes(string){var result=[];var re=/([a-zA-Z-_]*)(\=\")([a-zA-Z0-9-]*)(\")/g;var match=null;do{match=re.exec(string);if(match&&match.length>3){result.push({name:match[1],value:match[3]})}}while(match);return result}},{key:'getComponentTitle',value:function getComponentTitle(name){return SUPPORTED_COMPONENTS[name].title}},{key:'replaceShortcodes',value:function replaceShortcodes(content){var _this7=this;return content.replace(/(\[kunta_api_service_component)([a-zA-Z0-9 -=]*)(\])/g,function(all,tag,attributesText,end){var attributes=_this7.parseAttributes(attributesText);var placeholder=$('<input>').attr({'type':'button','data-kunta-api-placeholder':'service'}).css(_this7.buttonStyle);for(var i=0;i<attributes.length;i++){var attribute=attributes[i];placeholder.attr('data-'+attribute.name,attribute.value)}var component=placeholder.attr('data-component');if(!SUPPORTED_COMPONENTS[component]){return all}placeholder.attr('value',_this7.getComponentTitle(component));return $('<div>').append(placeholder).html()})}},{key:'restoreShortcodes',value:function restoreShortcodes(content){return content.replace(/<input [^>]+>/g,function(match){var input=$(match);if(input.attr('data-kunta-api-placeholder')==='service'){var shortcodeAttributes=[];var attributeNames=['service-id','component'];for(var i=0;i<attributeNames.length;i++){var attributeName=attributeNames[i];var attributeValue=input.attr('data-'+attributeName);shortcodeAttributes.push([attributeName,'"'+attributeValue+'"'].join('='))}return'[kunta_api_service_component '+shortcodeAttributes.join(' ')+']'}return match})}},{key:'openElementEditor',value:function openElementEditor(element){var placeholderAttr=element.attributes['data-kunta-api-placeholder'];if(placeholderAttr&&placeholderAttr.value==='service'){var serviceId=element.attributes['data-service-id'].value;this.editor.execCommand('kunta-api-service-edit','',{serviceId:serviceId})}}},{key:'findService',value:function findService(id,callback){$.post(ajaxurl,{'action':'kunta_api_load_service','serviceId':id},function(response){callback(null,JSON.parse(response))}).fail(function(response){callback(response.responseText||response.statusText)})}},{key:'onBeforeSetcontent',value:function onBeforeSetcontent(event){event.content=this.replaceShortcodes(event.content)}},{key:'onGetContent',value:function onGetContent(event){event.content=this.restoreShortcodes(event.content)}},{key:'onDblClick',value:function onDblClick(event){var element=event.target;this.openElementEditor(element)}},{key:'onServiceEdit',value:function onServiceEdit(ui,options){var _this8=this;this.findService(options.serviceId,function(err,service){if(err){tinyMCE.activeEditor.windowManager.alert(err)}else{console.log('Service',service);var dialog=new ServiceDialog(_this8.editor,service);dialog.open()}})}}]);return ServiceEditor}();var ServiceEmbed=function(){function ServiceEmbed(editor){_classCallCheck(this,ServiceEmbed);this.editor=editor;this.displayLocale='fi';this.searching=false;this.pending=false;this.addButton()}_createClass(ServiceEmbed,[{key:'addButton',value:function addButton(){var _this9=this;this.editor.addButton('kunta_api_service_embed',{title:'Search Kunta API services',onclick:function onclick(){_this9.editor.windowManager.open({title:'Search Kunta API services',width:768,height:500,body:[{type:'textbox',name:'kunta-api-service-query',label:'Query',onKeyUp:function onKeyUp(e){if(!_this9.searching){_this9.searching=true;_this9.searchServices(e.target.value,function(response){_this9.searching=false;if(_this9.pending){_this9.searchServices(e.target.value,function(innerResponse){_this9.handleResponse(innerResponse)})}else{_this9.handleResponse(response)}})}else{_this9.pending=true}}},{type:'label',classes:'kunta-api-search-info',text:'Kirjoita hakusana yll\xE4 olevaan hakukentt\xE4\xE4n'},{type:'container',classes:'kunta-api-search-results',minHeight:400}],onsubmit:function onsubmit(e){var responseHtml='';var allEmbedsFromSameChannel=true;var componentsToEmbed=$('.service-component-embed-input:checked');componentsToEmbed.each(function(){var component=$(this).attr('data-component-type');var serviceId=$(this).attr('data-service-id');responseHtml+='[kunta_api_service_component service-id="'+serviceId+'" component="'+component+'"]'});_this9.editor.insertContent(responseHtml)}})}})}},{key:'searchServices',value:function searchServices(query,callback){$('.mce-kunta-api-search-results').empty();$('.mce-kunta-api-search-results').append($('<div>').addClass('mce-kunta-api-search-results-loader'));$('.mce-kunta-api-search-info').text('Ladataan...');$.post(ajaxurl,{'action':'kunta_api_search_services','data':query},function(response){$('.mce-kunta-api-search-results-loader').remove();callback(JSON.parse(response))})}},{key:'getLocalizedValueAndType',value:function getLocalizedValueAndType(values,locale,type){for(var i=0;i<values.length;i++){if(locale===values[i].language&&type===values[i].type){return values[i].value}}return null}},{key:'appendResult',value:function appendResult(result){var resultContainer=$('<div>').addClass('mce-kunta-api-search-result-row');var name=this.getLocalizedValueAndType(result.names,this.displayLocale,'Name');resultContainer.append($('<p>').addClass('mce-kunta-api-search-result-title').text(name));Object.keys(SUPPORTED_COMPONENTS).forEach(function(component){var options=SUPPORTED_COMPONENTS[component];resultContainer.append($('<p>').append($('<input>').addClass('service-component-embed-input').attr({'type':'checkbox','data-component-type':component,'data-service-id':result.id})).append($('<span>').text(options.title)))});$('.mce-kunta-api-search-results').append(resultContainer)}},{key:'handleResponse',value:function handleResponse(response){$('.mce-kunta-api-search-results').empty();if(response.length===0){$('.mce-kunta-api-search-info').text('Hakusanalla ei l\xF6ytynyt yht\xE4\xE4n palvelua')}else{$('.mce-kunta-api-search-info').text('Kirjoita hakusana yll\xE4 olevaan hakukentt\xE4\xE4n')}for(var i=0;i<response.length;i++){this.appendResult(response[i])}}}]);return ServiceEmbed}();tinymce.PluginManager.add('kunta_api_service_embed',function(editor,url){new ServiceEmbed(editor);new ServiceEditor(editor)})})(tinymce,jQuery);
//# sourceMappingURL=plugin.js.map
